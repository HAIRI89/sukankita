<!DOCTYPE html>
<html lang="ms" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pengurusan Sukan Sekolah (Live)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Poppins', sans-serif; }
        .medal-gold { background: linear-gradient(135deg, #ffd700, #fcd34d); color: #78350f; border: 1px solid #ca8a04; }
        .medal-silver { background: linear-gradient(135deg, #e2e8f0, #94a3b8); color: #0f172a; border: 1px solid #64748b; }
        .medal-bronze { background: linear-gradient(135deg, #fdba74, #ea580c); color: #431407; border: 1px solid #9a3412; }
        
        .tab-content { display: none; opacity: 0; transition: opacity 0.3s ease-in-out; }
        .tab-content.active { display: block; opacity: 1; }
        .tab-btn.active { @apply bg-white/10 text-white shadow-inner border-b-2 border-blue-400; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        
        /* PDF Styles - A4 Portrait optimized */
        .pdf-page {
            width: 210mm;
            min-height: 297mm;
            background: white;
            color: black;
            padding: 15mm;
            margin: 0 auto 20px auto;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            position: relative;
            box-sizing: border-box;
            page-break-after: always;
        }
        /* Landscape Mode */
        .pdf-page.landscape {
            width: 297mm;
            min-height: 210mm;
            padding: 10mm;
        }
        .pdf-page:last-child {
            page-break-after: avoid;
        }
        .pdf-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
        }
        .pdf-table th, .pdf-table td {
            border: 1px solid #000;
        }
    </style>

    <!-- Global UI Scripts (Non-Module) for Immediate Access -->
    <script>
        // Core UI Functions defined globally
        function toggleModal(id) { 
            const el = document.getElementById(id);
            if(el) el.classList.toggle('hidden'); 
        }

        function showToast(msg, type='success') {
            const t = document.getElementById('toast');
            if(!t) return;
            document.getElementById('toast-msg').innerText = msg;
            document.getElementById('toast-icon').innerText = type === 'error' ? 'âŒ' : 'âœ…';
            t.classList.remove('translate-x-full', 'opacity-0');
            setTimeout(() => t.classList.add('translate-x-full', 'opacity-0'), 3000);
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            const content = document.getElementById(tabId);
            const btn = document.querySelector(`[data-tab="${tabId}"]`);
            if(content) content.classList.add('active');
            if(btn) btn.classList.add('active');
        }

        function closePdfPreview() {
            document.getElementById('pdf-preview-modal').classList.add('hidden');
        }

        // PDF Download Function
        function downloadPDF() {
            const element = document.getElementById('pdf-preview-content');
            if (!element) return;
            
            // Use currentPdfFilename global if available, else default
            const filename = (typeof currentPdfFilename !== 'undefined') ? currentPdfFilename : 'dokumen.pdf';
            const orientation = (typeof currentPdfOrientation !== 'undefined') ? currentPdfOrientation : 'portrait';

            const opt = {
                margin:       0,
                filename:     filename,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: orientation }
            };

            // Show loading toast
            showToast("Sedang menjana PDF...", "info");

            html2pdf().set(opt).from(element).save().then(() => {
                showToast("PDF berjaya dimuat turun!");
            }).catch(err => {
                console.error(err);
                showToast("Gagal menjana PDF", "error");
            });
        }
    </script>
</head>
<body class="h-full bg-slate-900 text-white flex flex-col overflow-hidden">

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden transition-opacity duration-300">
        <div class="bg-white rounded-2xl p-8 w-96 text-gray-800 shadow-2xl">
            <h2 class="text-2xl font-bold text-center mb-6">Admin Access</h2>
            <input type="password" id="admin-password" class="w-full px-4 py-3 border rounded-xl mb-4 outline-none focus:border-blue-500" placeholder="Kata Laluan">
            <div class="flex gap-2 mt-4">
                <button onclick="handleLogin()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold">Masuk</button>
                <button onclick="toggleModal('login-modal')" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-600 py-3 rounded-xl font-bold">Batal</button>
            </div>
        </div>
    </div>

    <!-- Reset Confirmation Modal -->
    <div id="reset-confirm-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden transition-opacity duration-300">
        <div class="bg-white rounded-2xl p-8 w-96 text-gray-800 shadow-2xl text-center">
            <div class="text-5xl mb-4">âš ï¸</div>
            <h2 class="text-xl font-bold mb-2">Adakah anda pasti?</h2>
            <p class="text-sm text-gray-600 mb-6">Tindakan ini akan memadam SEMUA data (Murid, Acara, Jadual, Keputusan) dan menetapkan semula sistem ke asal.</p>
            <div class="flex gap-2">
                <button onclick="performReset()" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 rounded-xl font-bold">Ya, Reset</button>
                <button onclick="toggleModal('reset-confirm-modal')" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-600 py-3 rounded-xl font-bold">Batal</button>
            </div>
        </div>
    </div>

    <!-- Registration Popup Modal -->
    <div id="reg-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden transition-opacity duration-300">
        <div class="bg-slate-800 rounded-2xl w-full max-w-4xl h-[90vh] flex flex-col shadow-2xl border border-slate-600">
            <div class="p-6 border-b border-slate-700 flex justify-between items-center bg-slate-900/50 rounded-t-2xl">
                <div>
                    <h2 class="text-xl font-bold text-white flex items-center gap-2"><span>ğŸ“‹</span> Pengurusan Peserta</h2>
                    <p id="modal-event-title" class="text-blue-400 text-sm font-medium mt-1">...</p>
                </div>
                <button onclick="closeRegModal()" class="text-slate-400 hover:text-white transition"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            
            <div class="flex-1 overflow-hidden flex flex-col p-6 relative">
                
                <!-- VIEW 0: RELAY CHOICE (Hidden by default) -->
                <div id="reg-relay-choice-view" class="hidden flex flex-col items-center justify-center h-full space-y-6">
                    <h3 class="text-2xl font-bold text-white">Sila Pilih Jenis Pendaftaran</h3>
                    <p class="text-slate-400 text-sm">Ini adalah acara berpasukan (Relay).</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-2xl">
                        <button onclick="handleRelayChoice('individual')" class="bg-blue-600 hover:bg-blue-500 border-2 border-blue-500 text-white rounded-xl p-8 flex flex-col items-center gap-4 transition transform hover:scale-105">
                            <span class="text-5xl">ğŸ‘¤</span>
                            <span class="text-xl font-bold">Daftar Individu</span>
                            <span class="text-xs text-blue-200">Pilih murid dari senarai umum (Tanpa tapisan kategori)</span>
                        </button>
                        <button onclick="handleRelayChoice('team')" class="bg-purple-600 hover:bg-purple-500 border-2 border-purple-500 text-white rounded-xl p-8 flex flex-col items-center gap-4 transition transform hover:scale-105">
                            <span class="text-5xl">ğŸƒâ€â™‚ï¸ğŸƒâ€â™‚ï¸</span>
                            <span class="text-xl font-bold">Daftar Pasukan</span>
                            <span class="text-xs text-purple-200">Daftar pasukan mengikut Rumah Sukan</span>
                        </button>
                    </div>
                </div>

                <!-- VIEW 1: SELECTION LIST -->
                <div id="reg-selection-view" class="hidden flex flex-col h-full">
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                        <!-- Mode Switch (Hidden for Relay Logic now handled by popup, but kept for fallback) -->
                        <div id="relay-mode-switch" class="hidden bg-slate-700/50 p-1 rounded-lg inline-flex">
                            <button onclick="switchRegMode('individual')" id="btn-mode-individual" class="px-4 py-1.5 rounded-md text-sm font-medium bg-blue-600 text-white shadow-sm transition">Daftar Individu</button>
                            <button onclick="switchRegMode('team')" id="btn-mode-team" class="px-4 py-1.5 rounded-md text-sm font-medium text-slate-300 hover:text-white transition">Daftar Pasukan</button>
                        </div>
                        
                        <!-- Event Limit Status Badge -->
                        <div id="limit-status-badge" class="px-3 py-1 rounded-lg text-xs font-bold border hidden">
                             <!-- Populated by JS -->
                        </div>
                    </div>

                    <div id="reg-filters-container" class="flex flex-wrap gap-3 mb-4">
                        <select id="modal-filter-class" onchange="renderBulkStudentList()" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm outline-none text-white"><option value="">Semua Kelas</option></select>
                        <select id="modal-filter-house" onchange="renderBulkStudentList()" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm outline-none text-white"><option value="">Semua Rumah</option></select>
                        <input type="text" id="modal-search" oninput="renderBulkStudentList()" placeholder="Cari nama murid..." class="flex-1 bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm outline-none text-white">
                    </div>

                    <div class="flex-1 overflow-y-auto bg-slate-900/50 rounded-xl border border-slate-700 p-2">
                        <div id="modal-student-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2"></div>
                        <div id="modal-team-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 hidden"></div>
                        <p id="modal-empty-msg" class="text-center text-slate-500 py-10 hidden">Tiada data dijumpai.</p>
                    </div>
                    <div class="mt-2 flex justify-between items-center text-xs text-slate-400">
                        <span id="auto-filter-status" class="italic text-blue-400"></span>
                        <span>*Senarai ditapis secara automatik.</span>
                    </div>
                </div>

                <!-- VIEW 2: LANE ASSIGNMENT (Hidden by default) -->
                <div id="reg-lane-view" class="hidden flex flex-col h-full">
                    <div class="bg-blue-900/30 p-4 rounded-lg mb-4 border border-blue-500/30">
                        <h3 class="font-bold text-blue-300 mb-1">Tetapan Lorong Balapan</h3>
                        <p class="text-xs text-slate-400">Sila tetapkan nombor lorong (1-8) bagi setiap atlet yang dipilih.</p>
                    </div>
                    <div class="flex-1 overflow-y-auto bg-slate-900/50 rounded-xl border border-slate-700 p-4">
                        <div id="lane-assign-list" class="space-y-2"></div>
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-slate-700 bg-slate-900/50 rounded-b-2xl flex justify-between items-center">
                <span id="modal-selected-count" class="text-sm text-blue-300 font-bold">0 dipilih</span>
                <div class="flex gap-3">
                    <button onclick="closeRegModal()" id="btn-reg-cancel" class="px-6 py-2 rounded-lg text-slate-300 hover:bg-slate-700 font-medium transition">Batal</button>
                    <!-- Back Button for Lane View -->
                    <button onclick="backToSelection()" id="btn-reg-back" class="hidden px-6 py-2 rounded-lg text-slate-300 hover:bg-slate-700 font-medium transition">Kembali</button>
                    <!-- Main Action Button -->
                    <button onclick="handleRegAction()" id="btn-reg-save" class="px-6 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white font-bold shadow-lg transition transform active:scale-95">ğŸ’¾ Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF Preview Modal -->
    <div id="pdf-preview-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm flex flex-col z-50 hidden transition-opacity duration-300">
        <div class="flex justify-between items-center p-4 bg-slate-900 border-b border-slate-700 text-white shrink-0">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-lg"><span class="text-xl">ğŸ–¨ï¸</span></div>
                <div><h2 class="text-lg font-bold">Pratonton Cetakan</h2><p class="text-xs text-slate-400">Semak dokumen sebelum dimuat turun</p></div>
            </div>
            <div class="flex gap-3">
                <button onclick="downloadPDF()" class="bg-green-600 hover:bg-green-500 text-white px-5 py-2 rounded-lg font-bold text-sm flex items-center gap-2 shadow-lg transition hover:scale-105"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg> ğŸ“¥ Muat Turun PDF</button>
                <button onclick="closePdfPreview()" class="bg-slate-700 hover:bg-slate-600 text-white px-5 py-2 rounded-lg font-bold text-sm transition">Tutup</button>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto p-8 bg-gray-500/50 flex justify-center"><div id="pdf-preview-content" class="w-max"></div></div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed top-5 right-5 z-50 transform transition-all duration-300 translate-x-full opacity-0">
        <div class="bg-slate-800 border border-slate-600 text-white px-6 py-3 rounded-lg shadow-xl flex items-center gap-3">
            <span id="toast-icon" class="text-2xl">âœ…</span>
            <span id="toast-msg" class="font-medium">Notification</span>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-slate-800 border-b border-slate-700 flex-none z-10">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div id="header-logo-container" class="w-12 h-12 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-lg flex items-center justify-center text-2xl shadow-lg transform rotate-3">ğŸ¥‡</div>
                <div>
                    <h1 id="header-school-name" class="text-xl md:text-2xl font-bold text-white tracking-tight">Sukan Sekolah</h1>
                    <p id="header-year" class="text-slate-400 text-xs uppercase tracking-wider font-semibold">Sistem Pengurusan Kejohanan</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div id="connection-status" class="flex items-center gap-2 px-3 py-1 bg-slate-700 rounded-full text-xs font-medium text-slate-300"><span class="w-2 h-2 rounded-full bg-slate-500 animate-pulse"></span> Offline</div>
                <button onclick="toggleModal('login-modal')" class="bg-slate-700 hover:bg-slate-600 text-slate-200 px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">âš™ï¸ Admin</button>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-slate-800 border-b border-slate-700 flex-none overflow-x-auto">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex gap-2 py-2 min-w-max">
                <button onclick="switchTab('tab-scoreboard')" class="tab-btn active px-4 py-2 rounded-lg text-sm font-medium text-slate-300 hover:bg-slate-700 transition" data-tab="tab-scoreboard">ğŸ“Š Papan Markah</button>
                <button onclick="switchTab('tab-athletes')" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium text-slate-300 hover:bg-slate-700 transition" data-tab="tab-athletes">ğŸƒ Senarai Atlet</button>
                <button onclick="switchTab('tab-ranking')" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium text-slate-300 hover:bg-slate-700 transition" data-tab="tab-ranking">ğŸ… Ranking</button>
                <button onclick="switchTab('tab-champions')" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium text-slate-300 hover:bg-slate-700 transition" data-tab="tab-champions">ğŸ† Olahragawan</button>
                <button onclick="switchTab('tab-hopes')" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium text-slate-300 hover:bg-slate-700 transition" data-tab="tab-hopes">â­ Harapan</button>
                <button onclick="switchTab('tab-schedule')" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium text-slate-300 hover:bg-slate-700 transition" data-tab="tab-schedule">ğŸ“… Jadual</button>
                <button onclick="switchTab('tab-admin')" class="tab-btn admin-only hidden px-4 py-2 rounded-lg text-sm font-medium text-blue-300 border border-blue-500/30" data-tab="tab-admin">âš™ï¸ Tetapan</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto bg-slate-900 p-4 md:p-6 relative">
        <div class="max-w-7xl mx-auto h-full">
            
            <!-- Tab: Scoreboard -->
            <div id="tab-scoreboard" class="tab-content active space-y-6">
                <div class="grid lg:grid-cols-2 gap-6">
                    <div class="bg-slate-800/50 rounded-2xl p-6 backdrop-blur-sm border border-slate-700">
                        <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><span class="text-2xl">ğŸ </span> Kedudukan Rumah</h2>
                        <div id="house-rankings" class="space-y-3"></div>
                        <div class="mt-4 pt-4 border-t border-slate-600 text-xs text-slate-400">*Markah termasuk mata individu dan markah tambahan.</div>
                    </div>
                    <div class="bg-slate-800/50 rounded-2xl p-6 backdrop-blur-sm border border-slate-700">
                        <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><span class="text-2xl">ğŸ…</span> Jumlah Pingat</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead><tr class="border-b border-slate-600 text-slate-400"><th class="text-left py-2">Rumah</th><th class="text-center py-2 text-yellow-500">ğŸ¥‡</th><th class="text-center py-2 text-slate-300">ğŸ¥ˆ</th><th class="text-center py-2 text-orange-500">ğŸ¥‰</th><th class="text-center py-2">Total</th></tr></thead>
                                <tbody id="medal-tally" class="divide-y divide-slate-700"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="bg-slate-800/50 rounded-2xl p-6 backdrop-blur-sm border border-slate-700">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">ğŸ“¢ Keputusan Terkini (Selesai)</h2>
                    <div id="recent-results-list" class="space-y-2 max-h-60 overflow-y-auto scrollbar-thin"><p class="text-slate-500 italic text-center">Tiada keputusan direkodkan.</p></div>
                </div>
            </div>

            <!-- Tab: Athletes List -->
            <div id="tab-athletes" class="tab-content">
                <div class="bg-slate-800/50 rounded-2xl p-6 backdrop-blur-sm border border-slate-700">
                    <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                        <h2 class="text-xl font-bold flex items-center gap-2">ğŸƒ Senarai Atlet</h2>
                        <div class="flex flex-wrap gap-2">
                            <select id="filter-class" onchange="renderAthletesList()" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm outline-none text-white"><option value="">Semua Kelas</option></select>
                            <select id="filter-gender" onchange="renderAthletesList()" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm outline-none text-white"><option value="">Semua Jantina</option><option value="L">Lelaki</option><option value="P">Perempuan</option></select>
                            <select id="filter-category" onchange="renderAthletesList()" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm outline-none text-white"><option value="">Semua Kategori</option></select>
                            <input type="text" id="search-athlete" oninput="renderAthletesList()" placeholder="Cari nama..." class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm w-40 outline-none text-white">
                        </div>
                    </div>
                    <div id="athletes-list" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3 max-h-[60vh] overflow-y-auto pr-2"></div>
                </div>
            </div>

            <!-- Tab: Ranking -->
            <div id="tab-ranking" class="tab-content">
                <div class="bg-slate-800/50 rounded-2xl p-6 backdrop-blur-sm border border-slate-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold flex items-center gap-2">ğŸ“Š Ranking Individu</h2>
                        <div class="flex gap-2">
                            <select id="ranking-class-filter" onchange="renderRanking()" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-1 text-sm outline-none text-white"><option value="">Semua Kelas</option></select>
                            <select id="ranking-gender-filter" onchange="renderRanking()" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-1 text-sm outline-none text-white"><option value="">Semua Jantina</option><option value="L">Lelaki</option><option value="P">Perempuan</option></select>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm"><thead class="bg-slate-900/50 text-slate-400 uppercase font-medium"><tr><th class="p-3 rounded-l-lg">Ked</th><th class="p-3">Nama</th><th class="p-3">Kelas</th><th class="p-3">Rumah</th><th class="p-3">Kat</th><th class="p-3 text-center">ğŸ¥‡</th><th class="p-3 text-center">ğŸ¥ˆ</th><th class="p-3 text-center">ğŸ¥‰</th><th class="p-3 text-center">4th</th><th class="p-3 text-right rounded-r-lg">Mata</th></tr></thead><tbody id="ranking-table" class="divide-y divide-slate-700"></tbody></table>
                        <p id="no-ranking" class="text-center text-slate-400 py-8 hidden">Tiada data ranking.</p>
                    </div>
                </div>
            </div>

            <!-- Tab: Champions -->
            <div id="tab-champions" class="tab-content">
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-gradient-to-br from-blue-900 to-slate-800 rounded-2xl p-6 border border-blue-700 champion-glow text-center"><div class="text-6xl mb-4">ğŸ‘¨</div><h2 class="text-2xl font-bold text-yellow-400 mb-2">OLAHRAGAWAN</h2><div id="olahragawan-display" class="mt-4 text-slate-400">Belum ditentukan</div></div>
                    <div class="bg-gradient-to-br from-pink-900 to-slate-800 rounded-2xl p-6 border border-pink-700 champion-glow text-center"><div class="text-6xl mb-4">ğŸ‘©</div><h2 class="text-2xl font-bold text-yellow-400 mb-2">OLAHRAGAWATI</h2><div id="olahragawati-display" class="mt-4 text-slate-400">Belum ditentukan</div></div>
                </div>
            </div>

            <!-- Tab: Hopes -->
            <div id="tab-hopes" class="tab-content">
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-gradient-to-br from-cyan-900 to-slate-800 rounded-2xl p-6 border border-cyan-700"><div class="text-center mb-4"><div class="w-20 h-20 bg-cyan-500/20 rounded-full mx-auto flex items-center justify-center mb-3 shadow-lg"><span class="text-4xl">â­</span></div><h2 class="text-xl font-bold text-cyan-400">ATLET HARAPAN LELAKI</h2><p class="text-slate-400 text-sm">Tahap 2 (Tahun 4 & 5)</p></div><div id="hope-male-display" class="text-center"></div></div>
                    <div class="bg-gradient-to-br from-purple-900 to-slate-800 rounded-2xl p-6 border border-purple-700"><div class="text-center mb-4"><div class="w-20 h-20 bg-purple-500/20 rounded-full mx-auto flex items-center justify-center mb-3 shadow-lg"><span class="text-4xl">â­</span></div><h2 class="text-xl font-bold text-purple-400">ATLET HARAPAN WANITA</h2><p class="text-slate-400 text-sm">Tahap 2 (Tahun 4 & 5)</p></div><div id="hope-female-display" class="text-center"></div></div>
                </div>
            </div>

            <!-- Tab: Schedule -->
            <div id="tab-schedule" class="tab-content">
                <div class="bg-slate-800/50 rounded-2xl p-6 backdrop-blur-sm border border-slate-700">
                    <h2 class="text-xl font-bold mb-4">ğŸ“… Jadual Pertandingan</h2>
                    <div id="schedule-list" class="space-y-3 max-h-[70vh] overflow-y-auto pr-2"></div>
                </div>
            </div>

            <!-- Tab: Admin -->
            <div id="tab-admin" class="tab-content">
                
                <!-- School Settings -->
                <div class="bg-slate-800/50 rounded-2xl p-6 backdrop-blur-sm border border-slate-700 mb-6">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">ğŸ« Tetapan Sekolah</h3>
                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div><label class="block text-sm font-medium mb-1">Nama Sekolah</label><input type="text" id="school-name-input" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white"></div>
                        <div><label class="block text-sm font-medium mb-1">Tahun</label><input type="text" id="school-year-input" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4 border-t border-slate-600 pt-4">
                        <div class="col-span-2"><h4 class="text-sm font-bold text-blue-300 mb-2">Tetapan Had Acara (Maksimum)</h4></div>
                        <div>
                            <label class="block text-xs font-medium mb-1">Individu</label>
                            <input type="number" id="limit-ind" class="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-sm text-white" value="3">
                        </div>
                        <div>
                            <label class="block text-xs font-medium mb-1">Berpasukan</label>
                            <input type="number" id="limit-team" class="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-sm text-white" value="2">
                        </div>
                        <div class="col-span-2 flex items-center gap-2">
                             <input type="checkbox" id="enable-limit" class="w-4 h-4 rounded text-blue-600 bg-slate-700 border-slate-600">
                             <label for="enable-limit" class="text-sm text-white">Aktifkan Had Acara</label>
                        </div>
                    </div>
                    <button onclick="saveSchoolSettings()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-bold transition">ğŸ’¾ Simpan Tetapan</button>
                </div>

                <!-- House Settings -->
                <div class="bg-slate-800/50 rounded-2xl p-6 backdrop-blur-sm border border-slate-700 mb-6">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">ğŸ  Tetapan Rumah Sukan</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="house-settings-container"></div>
                    <button onclick="saveHouseSettings()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-bold mt-4 transition">ğŸ’¾ Simpan Rumah Sukan</button>
                </div>

                <!-- Markah Tambahan -->
                <div class="bg-slate-800/50 rounded-2xl p-6 backdrop-blur-sm border border-slate-700 mb-6">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">â­ Markah Tambahan (Keseluruhan)</h3>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="bg-slate-700/30 p-4 rounded-xl border border-slate-600">
                            <div class="flex justify-between items-center mb-3"><h4 class="font-bold text-sm text-green-300">Merentas Desa</h4><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="ext-md-active" class="w-4 h-4 rounded text-green-500 bg-slate-800 border-slate-500"><span class="text-xs text-slate-300">Kira dalam keputusan</span></label></div>
                            <div class="grid grid-cols-2 gap-3" id="ext-md-inputs"></div>
                        </div>
                        <div class="bg-slate-700/30 p-4 rounded-xl border border-slate-600">
                            <div class="flex justify-between items-center mb-3"><h4 class="font-bold text-sm text-yellow-300">Sukantara</h4><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="ext-sk-active" class="w-4 h-4 rounded text-yellow-500 bg-slate-800 border-slate-500"><span class="text-xs text-slate-300">Kira dalam keputusan</span></label></div>
                            <div class="grid grid-cols-2 gap-3" id="ext-sk-inputs"></div>
                        </div>
                    </div>
                    <button onclick="saveExternalPoints()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg mt-4 text-sm transition">ğŸ’¾ Simpan Markah Tambahan</button>
                </div>

                <!-- Uploads -->
                <div class="grid lg:grid-cols-3 gap-6 mb-6">
                    <!-- Student Upload -->
                    <div class="bg-slate-800/50 rounded-2xl p-6 backdrop-blur-sm border border-slate-700">
                        <h3 class="text-lg font-bold mb-2 flex items-center gap-2">ğŸ‘¥ Muat Naik Murid (Excel/CSV)</h3>
                        <input type="file" id="excel-upload" accept=".xlsx,.xls,.csv" class="block w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 mb-3"/>
                        <div class="flex gap-2 mb-3">
                             <button onclick="uploadExcelStudents()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg text-sm font-bold">Muat Naik Data</button>
                             <button onclick="deleteAllStudents()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg text-sm font-bold" title="Padam Semua Murid">ğŸ—‘ï¸</button>
                        </div>
                        
                        <!-- Manual Entry Form -->
                        <div class="mt-4 border-t border-slate-600 pt-4">
                            <h4 class="font-bold text-sm text-slate-300 mb-2">Atau Tambah Secara Manual:</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
                                <input type="text" id="manual-name" placeholder="Nama Murid" class="bg-slate-700 border border-slate-600 rounded px-2 py-2 text-xs text-white outline-none">
                                <input type="text" id="manual-class" placeholder="Kelas" class="bg-slate-700 border border-slate-600 rounded px-2 py-2 text-xs text-white outline-none">
                                <select id="manual-house" class="bg-slate-700 border border-slate-600 rounded px-2 py-2 text-xs text-white outline-none">
                                    <option value="">Pilih Rumah Sukan</option>
                                </select>
                                <select id="manual-gender" class="bg-slate-700 border border-slate-600 rounded px-2 py-2 text-xs text-white outline-none">
                                    <option value="">Pilih Jantina</option>
                                    <option value="L">Lelaki</option>
                                    <option value="P">Perempuan</option>
                                </select>
                                <input type="text" id="manual-category" placeholder="Kategori (cth: L18)" class="bg-slate-700 border border-slate-600 rounded px-2 py-2 text-xs text-white outline-none">
                            </div>
                            <button onclick="addStudentManual()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 rounded text-xs font-bold transition">â• Tambah Murid</button>
                        </div>
                        
                        <div class="mt-4 bg-slate-900/50 rounded-lg p-3 border border-slate-600 hidden" id="upload-preview-container">
                            <div class="flex justify-between items-center mb-2"><h4 class="font-bold text-xs text-blue-300">Semakan Murid</h4><select id="preview-filter-class" onchange="renderUploadedStudentPreview()" class="bg-slate-800 border border-slate-600 rounded px-2 py-1 text-[10px] text-white"><option value="">Semua Kelas</option></select></div>
                            <div class="overflow-y-auto max-h-48 scrollbar-thin"><table class="w-full text-left text-xs"><thead class="bg-slate-800 text-slate-400 sticky top-0"><tr><th class="p-2">Nama</th><th class="p-2">Kelas</th><th class="p-2">Rumah</th><th class="p-2 text-center w-10">Tindakan</th></tr></thead><tbody id="upload-preview-body" class="divide-y divide-slate-700"></tbody></table></div>
                        </div>
                    </div>
                    <!-- Event Upload -->
                    <div class="bg-slate-800/50 rounded-2xl p-6 backdrop-blur-sm border border-slate-700">
                        <h3 class="text-lg font-bold mb-2 flex items-center gap-2">ğŸ“… Muat Naik Acara (Excel/CSV)</h3>
                        <input type="file" id="upload-events" accept=".xlsx,.xls,.csv" class="block w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-600 file:text-white hover:file:bg-purple-700 mb-3"/>
                        <div class="flex gap-2 mb-3">
                            <button onclick="processEventUpload()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg text-sm font-bold">Muat Naik Data</button>
                            <button onclick="deleteAllEvents()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg text-sm font-bold" title="Padam Semua Acara">ğŸ—‘ï¸</button>
                        </div>
                        <p class="text-[10px] text-slate-400 mt-2 mb-2">Kolum: A(Kod) | B(Nama) | C(Kategori) | D(Jenis) | E(Jantina)</p>

                        <!-- Manual Event Entry Form (NEW) -->
                        <div class="mt-4 border-t border-slate-600 pt-4">
                            <h4 class="font-bold text-sm text-purple-300 mb-2">Atau Tambah Acara Manual:</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
                                <input type="text" id="manual-event-code" placeholder="Kod (cth: 101)" class="bg-slate-700 border border-slate-600 rounded px-2 py-2 text-xs text-white outline-none">
                                <input type="text" id="manual-event-name" placeholder="Nama Acara" class="bg-slate-700 border border-slate-600 rounded px-2 py-2 text-xs text-white outline-none">
                                <select id="manual-event-type" class="bg-slate-700 border border-slate-600 rounded px-2 py-2 text-xs text-white outline-none">
                                    <option value="">Jenis</option>
                                    <option value="track">Balapan</option>
                                    <option value="field">Padang</option>
                                </select>
                                <input type="text" id="manual-event-category" placeholder="Kategori (cth: L18)" class="bg-slate-700 border border-slate-600 rounded px-2 py-2 text-xs text-white outline-none">
                                <select id="manual-event-gender" class="bg-slate-700 border border-slate-600 rounded px-2 py-2 text-xs text-white outline-none">
                                    <option value="">Jantina</option>
                                    <option value="L">Lelaki</option>
                                    <option value="P">Perempuan</option>
                                </select>
                            </div>
                            <button onclick="addEventManual()" class="w-full bg-purple-600 hover:bg-purple-500 text-white py-2 rounded text-xs font-bold transition">â• Tambah Acara</button>
                        </div>

                        <!-- Event Preview List -->
                        <div class="mt-4 bg-slate-900/50 rounded-lg p-3 border border-slate-600 hidden" id="event-preview-container">
                             <div class="flex justify-between items-center mb-2"><h4 class="font-bold text-xs text-purple-300">Senarai Acara</h4></div>
                             <div class="overflow-y-auto max-h-48 scrollbar-thin"><table class="w-full text-left text-xs"><thead class="bg-slate-800 text-slate-400 sticky top-0"><tr><th class="p-2">Kod</th><th class="p-2">Nama</th><th class="p-2">Kat</th><th class="p-2 text-center w-10">Aksi</th></tr></thead><tbody id="event-preview-body" class="divide-y divide-slate-700"></tbody></table></div>
                        </div>
                    </div>
                    <!-- Schedule Upload -->
                    <div class="bg-slate-800/50 rounded-2xl p-6 backdrop-blur-sm border border-slate-700">
                        <h3 class="text-lg font-bold mb-2 flex items-center gap-2">ğŸ•’ Muat Naik Jadual (Excel/CSV)</h3>
                        <input type="file" id="upload-schedule" accept=".xlsx,.xls,.csv" class="block w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-orange-600 file:text-white hover:file:bg-orange-700 mb-3"/>
                         <div class="flex gap-2 mb-3">
                            <button onclick="uploadSchedule()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg text-sm font-bold">Muat Naik Data</button>
                            <button onclick="deleteAllSchedule()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg text-sm font-bold" title="Padam Semua Jadual">ğŸ—‘ï¸</button>
                        </div>
                        <p class="text-[10px] text-slate-400 mt-2 mb-2">Kolum: A(Masa) | B(Acara) | C(Kategori) | D(Lokasi)</p>

                        <!-- Schedule Preview List -->
                        <div class="mt-4 bg-slate-900/50 rounded-lg p-3 border border-slate-600 hidden" id="schedule-preview-container">
                             <div class="flex justify-between items-center mb-2"><h4 class="font-bold text-xs text-orange-300">Jadual Semasa</h4></div>
                             <div class="overflow-y-auto max-h-48 scrollbar-thin"><table class="w-full text-left text-xs"><thead class="bg-slate-800 text-slate-400 sticky top-0"><tr><th class="p-2">Masa</th><th class="p-2">Acara</th><th class="p-2 text-center w-10">Aksi</th></tr></thead><tbody id="schedule-preview-body" class="divide-y divide-slate-700"></tbody></table></div>
                        </div>
                    </div>
                </div>

                <!-- Event Registration (EDIT MODE) -->
                <div class="bg-slate-800/50 rounded-2xl p-6 backdrop-blur-sm border border-slate-700 mb-6">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">ğŸ“‹ Daftar & Edit Peserta Acara</h3>
                    <div class="bg-slate-900/50 p-6 rounded-xl border border-slate-600 text-center">
                        <label class="block text-slate-300 font-medium mb-3">Pilih Acara untuk Menguruskan Pendaftaran:</label>
                        <div class="max-w-md mx-auto">
                            <select id="reg-event-select-bulk" onchange="openBulkRegModal(this.value)" class="w-full bg-slate-800 border border-slate-500 rounded-xl px-4 py-3 text-base outline-none focus:ring-2 focus:ring-blue-500 transition cursor-pointer hover:bg-slate-700 text-white"><option value="">-- Sila Pilih Acara --</option></select>
                        </div>
                    </div>
                </div>

                <!-- Result Entry -->
                <div class="bg-slate-800 rounded-2xl p-6 border border-slate-700 mb-6">
                    <h3 class="text-lg font-bold mb-4 text-blue-400">ğŸ… Rekod Keputusan</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 mb-1">1. Pilih Acara</label>
                            <select id="result-event" onchange="loadEventParticipants()" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2.5 outline-none text-white"></select>
                        </div>
                        <div id="result-stage-container" class="hidden">
                            <label class="block text-xs font-bold text-slate-400 mb-2">2. Peringkat</label>
                            <div class="flex gap-4">
                                <label class="flex items-center gap-2 cursor-pointer bg-slate-700 px-4 py-2 rounded-lg hover:bg-slate-600"><input type="radio" name="result-stage" value="Saringan" onchange="toggleResultTable()" class="w-4 h-4 text-blue-600"><span class="text-sm">Saringan</span></label>
                                <label class="flex items-center gap-2 cursor-pointer bg-slate-700 px-4 py-2 rounded-lg hover:bg-slate-600"><input type="radio" name="result-stage" value="Akhir" onchange="toggleResultTable()" class="w-4 h-4 text-blue-600"><span class="text-sm font-bold text-yellow-400">Akhir (Kira Mata)</span></label>
                            </div>
                        </div>
                        <div id="result-entry-table-container" class="hidden mt-4">
                            <label class="block text-xs font-bold text-slate-400 mb-2">3. Masukkan Keputusan (Tanda pemenang & isi masa)</label>
                            <div class="bg-slate-900 rounded-lg border border-slate-600 overflow-hidden">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-slate-700 text-slate-300"><tr><th class="p-3">Nama Atlet</th><th class="p-3 w-32">Kedudukan</th><th class="p-3 w-40">Catatan (Masa/Jarak)</th></tr></thead>
                                    <tbody id="result-entry-tbody" class="divide-y divide-slate-600"></tbody>
                                </table>
                            </div>
                            <div class="mt-2 text-[10px] text-slate-400">*Sistem Pemarkahan: Emas=7, Perak=5, Gangsa=3, Keempat=1, Kelima ke atas=0</div>
                            <button onclick="submitDetailedResult()" class="w-full bg-green-600 hover:bg-green-500 text-white py-3 rounded-lg font-bold mt-4 shadow-lg">Simpan Keputusan</button>
                        </div>
                        
                        <!-- Completed Results Table -->
                        <div class="mt-8 pt-6 border-t border-slate-700">
                             <h4 class="font-bold text-sm text-white mb-4">Senarai Acara Selesai (Rekod Keputusan)</h4>
                             <div class="bg-slate-900 rounded-lg border border-slate-600 overflow-hidden">
                                 <table class="w-full text-sm text-left">
                                     <thead class="bg-slate-700 text-slate-300 text-xs"><tr><th class="p-3">Acara</th><th class="p-3 w-32 text-center">Tindakan</th></tr></thead>
                                     <tbody id="completed-results-tbody" class="divide-y divide-slate-600"><tr><td colspan="2" class="p-3 text-center text-slate-500 italic">Tiada acara selesai.</td></tr></tbody>
                                 </table>
                             </div>
                        </div>

                        <!-- Screening Results Table -->
                        <div class="mt-8 pt-6 border-t border-slate-700">
                             <h4 class="font-bold text-sm text-white mb-4 flex items-center gap-2">
                                <span class="bg-blue-600 text-xs px-2 py-1 rounded text-white">Saringan</span>
                                Rekod Keputusan Saringan
                             </h4>
                             <div class="bg-slate-900 rounded-lg border border-slate-600 overflow-hidden">
                                 <table class="w-full text-sm text-left">
                                     <thead class="bg-slate-700 text-slate-300 text-xs"><tr><th class="p-3">Acara</th><th class="p-3">Masa Rekod</th><th class="p-3 w-32 text-center">Tindakan</th></tr></thead>
                                     <tbody id="screening-results-tbody" class="divide-y divide-slate-600"><tr><td colspan="3" class="p-3 text-center text-slate-500 italic">Tiada keputusan saringan.</td></tr></tbody>
                                 </table>
                             </div>
                        </div>
                    </div>
                </div>

                <!-- Printing Section (REVISED) -->
                <div class="bg-slate-800/50 rounded-2xl p-6 backdrop-blur-sm border border-slate-700 mb-6">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">ğŸ–¨ï¸ Cetak Dokumen</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button onclick="printTrackForms()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-4 rounded-xl text-sm font-bold flex flex-col items-center justify-center gap-2 shadow-lg transition transform hover:scale-[1.02]">
                            <span class="text-2xl">ğŸƒ</span> 
                            <span>Cetak Borang Balapan (Track)</span>
                            <span class="text-[10px] font-normal opacity-70">Lari Pecut, 4x100m, dll</span>
                        </button>
                        <button onclick="printFieldForms()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-4 rounded-xl text-sm font-bold flex flex-col items-center justify-center gap-2 shadow-lg transition transform hover:scale-[1.02]">
                            <span class="text-2xl">ğŸ¥</span> 
                            <span>Cetak Borang Padang (Field)</span>
                            <span class="text-[10px] font-normal opacity-70">Lompat Jauh, Lontar Peluru, dll</span>
                        </button>
                    </div>
                </div>

                <div class="flex justify-end items-center mt-8 pt-4 border-t border-slate-700">
                    <button onclick="requestReset()" class="text-red-400 text-xs hover:text-red-300 underline">Reset Data Sistem</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Hidden Container for PDF Generation -->
    <div id="pdf-container" class="hidden"></div>
    <!-- PDF Preview Modal -->
    <div id="pdf-preview-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm flex flex-col z-50 hidden transition-opacity duration-300">
        <div class="flex justify-between items-center p-4 bg-slate-900 border-b border-slate-700 text-white shrink-0">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-lg"><span class="text-xl">ğŸ–¨ï¸</span></div>
                <div><h2 class="text-lg font-bold">Pratonton Cetakan</h2><p class="text-xs text-slate-400">Semak dokumen sebelum dimuat turun</p></div>
            </div>
            <div class="flex gap-3">
                <button onclick="downloadPDF()" class="bg-green-600 hover:bg-green-500 text-white px-5 py-2 rounded-lg font-bold text-sm flex items-center gap-2 shadow-lg transition hover:scale-105"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg> ğŸ“¥ Muat Turun PDF</button>
                <button onclick="closePdfPreview()" class="bg-slate-700 hover:bg-slate-600 text-white px-5 py-2 rounded-lg font-bold text-sm transition">Tutup</button>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto p-8 bg-gray-500/50 flex justify-center"><div id="pdf-preview-content" class="w-max"></div></div>
    </div>

<script type="module">
    // Import Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Firebase Configuration ---
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';

    // Initialize Firebase
    let app, auth, db;
    let isFirebaseReady = false;

    try {
        if (firebaseConfig && firebaseConfig.apiKey) {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            isFirebaseReady = true;
        } else {
            console.warn("Firebase config not found. Running in local mode.");
        }
    } catch (e) {
        console.error("Firebase init error:", e);
    }

    // --- Initial Data ---
    const defaultData = {
        config: { schoolName: 'Sukan Sekolah 2026', year: '2026', enableEventLimit: false, maxInd: 3, maxTeam: 2 },
        houses: [
            { id: 'Merah', name: 'Rumah Merah', active: true },
            { id: 'Biru', name: 'Rumah Biru', active: true },
            { id: 'Kuning', name: 'Rumah Kuning', active: true },
            { id: 'Hijau', name: 'Rumah Hijau', active: true }
        ],
        athletes: [], 
        events: [],
        scheduleItems: [],
        resultsLog: [],
        pointsConfig: { gold: 7, silver: 5, bronze: 3, fourth: 1 },
        externalPoints: {
            merentasDesa: { enabled: false, scores: { 'Merah': 0, 'Biru': 0, 'Kuning': 0, 'Hijau': 0 } },
            sukantara: { enabled: false, scores: { 'Merah': 0, 'Biru': 0, 'Kuning': 0, 'Hijau': 0 } }
        }
    };

    let appData = JSON.parse(localStorage.getItem('sukanData')) || defaultData;
    let currentBulkEventId = null;
    let bulkSelectedAthletes = new Set();
    let currentRegMode = 'individual';
    let currentPdfFilename = 'dokumen.pdf';
    let currentPdfOrientation = 'portrait';
    let isStrictCategoryFilter = true; // NEW: Global flag for strict filtering

    // Migrations
    if(!appData.houses || !appData.houses[0].id) appData.houses = defaultData.houses; 
    if(!appData.resultsLog) appData.resultsLog = [];
    if(!appData.externalPoints) appData.externalPoints = defaultData.externalPoints;
    if(!appData.scheduleItems) appData.scheduleItems = [];
    if(appData.config.enableEventLimit === undefined) appData.config.enableEventLimit = false;
    if(appData.config.maxInd === undefined) appData.config.maxInd = 3;
    if(appData.config.maxTeam === undefined) appData.config.maxTeam = 2;
    appData.pointsConfig = { gold: 7, silver: 5, bronze: 3, fourth: 1 };

    // --- Firebase Sync Logic ---
    window.initFirebaseSync = async function() {
        if (!isFirebaseReady) return;
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        } catch (error) {
            console.error("Auth Error:", error);
            showToast("Gagal sambung ke server.", "error");
            return;
        }
        onAuthStateChanged(auth, (user) => {
            if (user) {
                const statusDiv = document.getElementById('connection-status');
                if(statusDiv) {
                    statusDiv.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500"></span> Online';
                    statusDiv.classList.replace('text-slate-300', 'text-green-300');
                }
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'sukan_main_data', 'app_data');
                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        appData = docSnap.data();
                        localStorage.setItem('sukanData', JSON.stringify(appData));
                        renderAll();
                    } else {
                        saveData(); 
                    }
                }, (error) => {
                    console.error("Sync Error:", error);
                    showToast("Terputus hubungan server.", "error");
                });
            }
        });
    }

    // --- Core Functions ---
    window.saveData = function() { 
        localStorage.setItem('sukanData', JSON.stringify(appData));
        if (isFirebaseReady && auth.currentUser) {
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'sukan_main_data', 'app_data');
            setDoc(docRef, appData).catch(e => console.error("Save failed:", e));
        }
        renderAll(); 
    }

    // Modal helpers (overwritten from global scope for access within module if needed)
    window.toggleModal = function(id) { 
        const el = document.getElementById(id);
        if(el) el.classList.toggle('hidden'); 
    }

    window.handleLogin = function() {
        if(document.getElementById('admin-password').value === 'admin123') {
            document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
            toggleModal('login-modal');
            switchTab('tab-admin');
            initAdminInputs();
        } else { 
            alert("Kata laluan salah!");
        }
    }

    // --- Helpers ---
    window.getHouseColor = function(houseId) {
        if(!houseId) return '#64748b'; 
        if(houseId === 'Merah') return '#ef4444';
        if(houseId === 'Biru') return '#3b82f6';
        if(houseId === 'Kuning') return '#eab308';
        if(houseId === 'Hijau') return '#22c55e';
        return '#64748b'; 
    }
    window.getNormalizedHouseId = function(rawHouse) {
         const raw = (rawHouse || "").toString().trim().toLowerCase();
         if(raw.includes('merah')) return 'Merah';
         if(raw.includes('biru')) return 'Biru';
         if(raw.includes('kuning')) return 'Kuning';
         if(raw.includes('hijau')) return 'Hijau';
         const houseByName = appData.houses.find(h => h.name.toLowerCase() === raw);
         return houseByName ? houseByName.id : (rawHouse || "Tidak Diketahui"); 
    }
    window.getDisplayHouseName = function(houseIdOrName) {
        const normalizedId = getNormalizedHouseId(houseIdOrName);
        const h = appData.houses.find(x => x.id === normalizedId);
        return h ? h.name : houseIdOrName;
    }
    window.getCategoryBadge = function(cat) { return `category-${cat}`; }
    
    // Updated Helper: checkClassYear
    window.checkClassYear = function(className, allowedYears) {
        if (!className) return false;
        const firstChar = className.trim().charAt(0);
        return allowedYears.includes(firstChar);
    }

    // Updated: getTopAthletes with year filtering support
    window.getTopAthletes = function(gender, allowedYears = null) {
        let athletes = [...appData.athletes];
        if (gender) athletes = athletes.filter(a => a.gender === gender);
        
        if (allowedYears) {
            athletes = athletes.filter(a => checkClassYear(a.class, allowedYears));
        }

        return athletes.sort((a, b) => {
            if ((b.medals.gold || 0) !== (a.medals.gold || 0)) return (b.medals.gold || 0) - (a.medals.gold || 0);
            if ((b.medals.silver || 0) !== (a.medals.silver || 0)) return (b.medals.silver || 0) - (a.medals.silver || 0);
            return b.points - a.points;
        });
    }
    
    window.getUniqueCategories = function() {
        const cats = new Set(appData.athletes.map(a => a.category).filter(c => c));
        return Array.from(cats).sort();
    }

    // --- Render Functions ---
    window.renderScoreboard = function() {
        document.getElementById('header-school-name').innerText = appData.config.schoolName;
        document.getElementById('header-year').innerText = "Sukan Tahunan " + appData.config.year;
        const houseStats = {};
        appData.houses.filter(h => h.active !== false).forEach(h => { houseStats[h.id] = { id: h.id, name: h.name, gold:0, silver:0, bronze:0, points:0 }; });
        appData.athletes.forEach(a => {
            const hId = getNormalizedHouseId(a.house);
            if(houseStats[hId]) {
                houseStats[hId].gold += (a.medals.gold || 0); houseStats[hId].silver += (a.medals.silver || 0); houseStats[hId].bronze += (a.medals.bronze || 0); houseStats[hId].points += a.points;
            }
        });
        const ext = appData.externalPoints;
        const houses = ['Merah', 'Biru', 'Kuning', 'Hijau'];
        if (ext.merentasDesa.enabled) houses.forEach(id => { if(houseStats[id]) houseStats[id].points += parseInt(ext.merentasDesa.scores[id] || 0); });
        if (ext.sukantara.enabled) houses.forEach(id => { if(houseStats[id]) houseStats[id].points += parseInt(ext.sukantara.scores[id] || 0); });

        const sortedHouses = Object.values(houseStats).sort((a,b) => b.points - a.points);
        document.getElementById('house-rankings').innerHTML = sortedHouses.map((h, i) => `
            <div class="flex items-center justify-between p-4 rounded-xl shadow-lg relative overflow-hidden group mb-3" style="background: ${getHouseColor(h.id)}; color: white;">
                <div class="flex items-center gap-4 z-10"><span class="text-2xl font-bold w-8 text-center bg-black/20 rounded-lg py-1">${i+1}</span><div><h3 class="font-bold text-lg">${h.name}</h3><p class="text-xs opacity-90">Pungutan: ${h.gold}E ${h.silver}P ${h.bronze}G</p></div></div><div class="text-4xl font-black z-10">${h.points}</div>
            </div>
        `).join('');
        document.getElementById('medal-tally').innerHTML = sortedHouses.map(h => `
            <tr class="hover:bg-slate-700/30 transition"><td class="py-3 px-2 font-medium"><span class="inline-block w-2 h-2 rounded-full mr-2" style="background: ${getHouseColor(h.id)}"></span>${h.name}</td><td class="text-center py-3 text-yellow-400 font-bold bg-yellow-900/10">${h.gold}</td><td class="text-center py-3 text-slate-300 font-bold bg-slate-700/10">${h.silver}</td><td class="text-center py-3 text-orange-400 font-bold bg-orange-900/10">${h.bronze}</td><td class="text-center py-3 font-bold text-blue-400">${h.gold+h.silver+h.bronze}</td></tr>
        `).join('');
        const logContainer = document.getElementById('recent-results-list');
        const completedEvents = appData.events.filter(e => e.status === 'completed').reverse();
        logContainer.innerHTML = completedEvents.length === 0 ? '<p class="text-slate-500 italic text-center">Tiada keputusan direkodkan.</p>' : completedEvents.map(ev => `
            <div class="bg-slate-800 p-3 rounded border border-slate-700 text-xs flex justify-between items-center">
                <div>
                    <div class="font-bold text-blue-300">${ev.name}</div>
                    <div class="text-slate-400">${ev.category}</div>
                </div>
                <button onclick="printSingleResult('${ev.id}')" class="bg-green-600 hover:bg-green-500 text-white px-2 py-1 rounded text-[10px] font-bold">ğŸ‘ï¸ Lihat</button>
            </div>
        `).join('');
    }

    // ... (Other render functions kept same) ...
    window.renderAthletesList = function() {
        const gender = document.getElementById('filter-gender').value;
        const category = document.getElementById('filter-category').value;
        const classFilter = document.getElementById('filter-class').value;
        const search = document.getElementById('search-athlete').value.toLowerCase();
        
        const cats = getUniqueCategories();
        const catSelect = document.getElementById('filter-category');
        if (catSelect.options.length <= 1) catSelect.innerHTML = '<option value="">Semua Kategori</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join('');
        
        const classSelect = document.getElementById('filter-class');
        const uniqueClasses = [...new Set(appData.athletes.map(a => a.class))].filter(Boolean).sort();
        const currentClass = classSelect.value;
        if (classSelect.options.length <= 1 || classSelect.options.length !== uniqueClasses.length + 1) {
             classSelect.innerHTML = '<option value="">Semua Kelas</option>' + uniqueClasses.map(c => `<option value="${c}">${c}</option>`).join('');
             classSelect.value = currentClass;
        }

        const filtered = appData.athletes.filter(a => 
            (gender === '' || a.gender === gender) && 
            (category === '' || a.category === category) && 
            (classFilter === '' || a.class === classFilter) &&
            (a.name.toLowerCase().includes(search))
        );
        
        document.getElementById('athletes-list').innerHTML = filtered.map(a => {
            const taggedEventIds = (appData.events || []).filter(e => (e.participants || []).includes(a.id.toString()));
            const eventNames = taggedEventIds.map(e => e.name).join(', ') || '-';
            
            return `
            <div class="bg-slate-800 p-3 rounded-xl border border-slate-700 flex flex-col gap-2 hover:bg-slate-700 transition">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-slate-900 flex items-center justify-center text-lg shadow-inner">${a.gender === 'L' ? 'ğŸ‘¨' : 'ğŸ‘©'}</div>
                    <div class="flex-1 min-w-0">
                        <p class="font-bold text-sm truncate">${a.name}</p>
                        <p class="text-xs text-slate-400">${getDisplayHouseName(a.house)} â€¢ ${a.class || '-'} â€¢ Kat ${a.category}</p>
                    </div>
                    <div class="text-right"><span class="block font-bold text-blue-400">${a.points} mt</span><span class="text-[10px] text-slate-500">${a.medals.gold}E ${a.medals.silver}P ${a.medals.bronze}G</span></div>
                </div>
                <div class="mt-1 pt-2 border-t border-slate-600">
                    <p class="text-[10px] text-slate-300 font-bold">Acara:</p>
                    <p class="text-[10px] text-slate-400 italic leading-tight">${eventNames}</p>
                </div>
            </div>`;
        }).join('') || '<div class="col-span-full text-center py-10 text-slate-500">Tiada atlet dijumpai.</div>';
    }

    window.renderRanking = function() {
        const gender = document.getElementById('ranking-gender-filter').value;
        const classFilter = document.getElementById('ranking-class-filter').value;
        
        const classSelect = document.getElementById('ranking-class-filter');
        const uniqueClasses = [...new Set(appData.athletes.map(a => a.class))].filter(Boolean).sort();
        const currentClass = classSelect.value;
        if (classSelect.options.length <= 1 || classSelect.options.length !== uniqueClasses.length + 1) {
             classSelect.innerHTML = '<option value="">Semua Kelas</option>' + uniqueClasses.map(c => `<option value="${c}">${c}</option>`).join('');
             classSelect.value = currentClass;
        }

        let athletes = getTopAthletes(gender || null);
        
        if (classFilter) {
            athletes = athletes.filter(a => a.class === classFilter);
        }
        
        athletes = athletes.slice(0, 50);
        
        const noRanking = document.getElementById('no-ranking');
        if(athletes.length === 0) { document.getElementById('ranking-table').innerHTML = ''; noRanking.classList.remove('hidden'); return; }
        noRanking.classList.add('hidden');
        document.getElementById('ranking-table').innerHTML = athletes.map((a, i) => `
            <tr class="hover:bg-slate-800 transition border-b border-slate-800 last:border-0"><td class="p-3 text-slate-500 font-mono">${i < 3 ? ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][i] : i + 1}</td><td class="p-3 font-medium">${a.name}</td><td class="p-3 text-xs opacity-75">${a.class || '-'}</td><td class="p-3 text-xs opacity-75"><span class="inline-block w-2 h-2 rounded-full mr-1" style="background: ${getHouseColor(getNormalizedHouseId(a.house))}"></span>${getDisplayHouseName(a.house)}</td><td class="p-3"><span class="category-badge ${getCategoryBadge(a.category)}">Kat ${a.category}</span></td><td class="p-3 text-center text-yellow-500 font-bold bg-yellow-900/10">${a.medals.gold}</td><td class="p-3 text-center text-slate-400 font-bold bg-slate-900/10">${a.medals.silver}</td><td class="p-3 text-center text-orange-500 font-bold bg-orange-900/10">${a.medals.bronze}</td><td class="p-3 text-center">${a.points >= 1 && !a.medals.gold && !a.medals.silver && !a.medals.bronze ? 'âœ”' : '-'}</td><td class="p-3 text-right font-bold text-blue-400">${a.points}</td></tr>
        `).join('');
    }

    // (Kept other render functions: renderChampions, renderHopes, renderSchedule) ...
    window.renderChampions = function() {
        const maleChampion = getTopAthletes('L', ['5', '6'])[0]; 
        const femaleChampion = getTopAthletes('P', ['5', '6'])[0];
        const renderChampCard = (p, id) => { document.getElementById(id).innerHTML = p && p.points > 0 ? `<div class="font-bold text-xl text-white mb-1">${p.name}</div><div class="text-sm text-slate-300 mb-3">${p.class || '-'} â€¢ ${getDisplayHouseName(p.house)} â€¢ ${p.points} Mata</div><div class="flex justify-center gap-4 text-xs font-bold"><span class="text-yellow-400 bg-yellow-900/30 px-2 py-1 rounded">ğŸ¥‡ ${p.medals.gold}</span><span class="text-slate-300 bg-slate-700/50 px-2 py-1 rounded">ğŸ¥ˆ ${p.medals.silver}</span><span class="text-orange-400 bg-orange-900/30 px-2 py-1 rounded">ğŸ¥‰ ${p.medals.bronze}</span></div>` : '<p class="text-slate-400">Belum ditentukan</p>'; };
        renderChampCard(maleChampion, 'olahragawan-display'); renderChampCard(femaleChampion, 'olahragawati-display');
    }

    window.renderHopes = function() {
        const maleHope = getTopAthletes('L', ['3', '4'])[0]; 
        const femaleHope = getTopAthletes('P', ['3', '4'])[0];
        const renderHopeCard = (p, id) => { document.getElementById(id).innerHTML = p && p.points > 0 ? `<div class="bg-slate-700/50 rounded-xl p-4 text-center"><div class="text-xl font-bold mb-1">${p.name}</div><div class="text-slate-300 text-sm mb-2">${p.class || '-'} â€¢ ${getDisplayHouseName(p.house)}</div><div class="mb-2"><span class="category-badge ${getCategoryBadge(p.category)}">Kat ${p.category}</span></div><div class="flex justify-center gap-3 text-xs mb-2"><span>ğŸ¥‡${p.medals.gold}</span><span>ğŸ¥ˆ${p.medals.silver}</span><span>ğŸ¥‰${p.medals.bronze}</span></div><div class="text-blue-400 font-bold">${p.points} Mata</div></div>` : '<p class="text-center text-slate-400">Belum ditentukan</p>'; };
        renderHopeCard(maleHope, 'hope-male-display'); renderHopeCard(femaleHope, 'hope-female-display');
    }

    window.renderSchedule = function() {
        const items = (appData.scheduleItems && appData.scheduleItems.length > 0) ? appData.scheduleItems : [];
        if (items.length > 0) {
            document.getElementById('schedule-list').innerHTML = `
                <div class="overflow-x-auto rounded-lg border border-slate-700">
                    <table class="w-full text-sm text-left text-slate-300">
                        <thead class="text-xs uppercase bg-slate-800 text-slate-400"><tr><th class="px-4 py-3">Masa</th><th class="px-4 py-3">Acara</th><th class="px-4 py-3">Kategori</th><th class="px-4 py-3">Lokasi</th></tr></thead>
                        <tbody class="divide-y divide-slate-700 bg-slate-800/50">${items.map(s => `<tr class="hover:bg-slate-700/50"><td class="px-4 py-3 font-medium text-white whitespace-nowrap">${s.time || '-'}</td><td class="px-4 py-3 font-medium text-white">${s.event}</td><td class="px-4 py-3"><span class="category-badge ${getCategoryBadge(s.category)}">${s.category || '-'}</span></td><td class="px-4 py-3">${s.venue || '-'}</td></tr>`).join('')}</tbody>
                    </table>
                </div>
            `;
        } else {
            document.getElementById('schedule-list').innerHTML = `
                <div class="overflow-x-auto rounded-lg border border-slate-700">
                    <table class="w-full text-sm text-left text-slate-300">
                        <thead class="text-xs uppercase bg-slate-800 text-slate-400"><tr><th class="px-4 py-3">Acara</th><th class="px-4 py-3">Kategori</th><th class="px-4 py-3">Jantina</th><th class="px-4 py-3 text-center">Status</th></tr></thead>
                        <tbody class="divide-y divide-slate-700 bg-slate-800/50">${appData.events.map(e => `<tr class="hover:bg-slate-700/50"><td class="px-4 py-3 font-medium text-white">${e.name}</td><td class="px-4 py-3"><span class="category-badge ${getCategoryBadge(e.category)}">${e.category}</span></td><td class="px-4 py-3">${e.gender}</td><td class="px-4 py-3 text-center">${e.status === 'completed' ? '<span class="bg-green-900 text-green-300 text-xs font-medium px-2.5 py-0.5 rounded">Selesai</span>' : '<span class="bg-blue-900 text-blue-300 text-xs font-medium px-2.5 py-0.5 rounded">Akan Datang</span>'}</td></tr>`).join('')}</tbody>
                    </table>
                </div>
            `;
        }
    }

    // --- Admin Logic (Kept same) ---
    window.initAdminInputs = function() {
        document.getElementById('school-name-input').value = appData.config.schoolName;
        document.getElementById('school-year-input').value = appData.config.year;
        document.getElementById('limit-ind').value = appData.config.maxInd || 3;
        document.getElementById('limit-team').value = appData.config.maxTeam || 2;
        document.getElementById('enable-limit').checked = (appData.config.enableEventLimit === true);

        const houseContainer = document.getElementById('house-settings-container');
        houseContainer.innerHTML = appData.houses.map(h => `<div class="bg-slate-700/30 p-3 rounded-lg border border-slate-600"><label class="block text-xs font-bold mb-1" style="color:${getHouseColor(h.id)}">Rumah ${h.id}</label><input type="text" id="house-name-${h.id}" class="w-full bg-slate-800 border border-slate-600 rounded px-2 py-1 text-sm mb-2 text-white" value="${h.name}"><label class="flex items-center gap-2 text-xs text-slate-300 cursor-pointer"><input type="checkbox" id="house-active-${h.id}" class="rounded bg-slate-800 border-slate-600" ${h.active !== false ? 'checked' : ''}> Papar di Dashboard</label></div>`).join('');

        const manualHouseSelect = document.getElementById('manual-house');
        if(manualHouseSelect) {
            manualHouseSelect.innerHTML = '<option value="">Pilih Rumah Sukan</option>' + appData.houses.map(h => `<option value="${h.id}">${h.name}</option>`).join('');
        }

        const ext = appData.externalPoints;
        const houseIds = ['Merah', 'Biru', 'Kuning', 'Hijau'];
        
        document.getElementById('ext-md-active').checked = ext.merentasDesa.enabled;
        document.getElementById('ext-md-inputs').innerHTML = houseIds.map(hid => { const hName = getDisplayHouseName(hid); return `<div><label class="text-[10px] block mb-1" style="color:${getHouseColor(hid)}">${hName}</label><input type="number" id="ext-md-${hid}" class="w-full bg-slate-800 border border-slate-600 rounded px-2 py-1 text-sm text-white" value="${ext.merentasDesa.scores[hid] || 0}"></div>`; }).join('');

        document.getElementById('ext-sk-active').checked = ext.sukantara.enabled;
        document.getElementById('ext-sk-inputs').innerHTML = houseIds.map(hid => { const hName = getDisplayHouseName(hid); return `<div><label class="text-[10px] block mb-1" style="color:${getHouseColor(hid)}">${hName}</label><input type="number" id="ext-sk-${hid}" class="w-full bg-slate-800 border border-slate-600 rounded px-2 py-1 text-sm text-white" value="${ext.sukantara.scores[hid] || 0}"></div>`; }).join('');

        refreshDropdowns();
        renderUploadedStudentPreview(); 
        renderCompletedResultsTable(); 
        renderScreeningResultsTable(); 
        renderEventPreview(); 
        renderSchedulePreview(); 
    }

    // ... (Save functions kept same) ...
    window.saveHouseSettings = function() {
        const ids = ['Merah', 'Biru', 'Kuning', 'Hijau'];
        ids.forEach(id => {
            const nameInput = document.getElementById(`house-name-${id}`);
            const activeInput = document.getElementById(`house-active-${id}`);
            const house = appData.houses.find(h => h.id === id);
            if(house && nameInput) { house.name = nameInput.value; house.active = activeInput.checked; }
        });
        saveData(); showToast('Tetapan rumah sukan dikemaskini.'); initAdminInputs();
    }

    window.saveExternalPoints = function() {
        const ext = appData.externalPoints;
        const ids = ['Merah', 'Biru', 'Kuning', 'Hijau'];
        ext.merentasDesa.enabled = document.getElementById('ext-md-active').checked;
        ids.forEach(id => { ext.merentasDesa.scores[id] = parseInt(document.getElementById(`ext-md-${id}`).value) || 0; });
        ext.sukantara.enabled = document.getElementById('ext-sk-active').checked;
        ids.forEach(id => { ext.sukantara.scores[id] = parseInt(document.getElementById(`ext-sk-${id}`).value) || 0; });
        saveData(); showToast("Markah tambahan disimpan!");
    }

    window.refreshDropdowns = function() {
        const sortedEvents = [...appData.events].sort((a, b) => {
            const codeA = a.code ? String(a.code) : '';
            const codeB = b.code ? String(b.code) : '';
            return codeA.localeCompare(codeB, undefined, { numeric: true }) || a.name.localeCompare(b.name);
        });

        const eventOptionsReg = '<option value="">-- Sila Pilih Acara --</option>' + sortedEvents.map(e => {
            const label = `${e.code ? '[' + e.code + '] ' : ''}${e.name} (${e.category})`;
            return `<option value="${e.id}">${label}</option>`
        }).join('');
        
        const regSelect = document.getElementById('reg-event-select-bulk');
        if(regSelect) regSelect.innerHTML = eventOptionsReg;
        
        const eventOptionsRes = '<option value="">Pilih Acara...</option>' + sortedEvents.map(e => {
             const label = `${e.code ? '[' + e.code + '] ' : ''}${e.name} (${e.category})`;
            return `<option value="${e.id}">${label}</option>`
        }).join('');
        
        const resSelect = document.getElementById('result-event');
        if(resSelect) resSelect.innerHTML = eventOptionsRes;
    }

    window.saveSchoolSettings = function() {
        appData.config.schoolName = document.getElementById('school-name-input').value;
        appData.config.year = document.getElementById('school-year-input').value;
        appData.config.maxInd = parseInt(document.getElementById('limit-ind').value) || 3;
        appData.config.maxTeam = parseInt(document.getElementById('limit-team').value) || 2;
        appData.config.enableEventLimit = document.getElementById('enable-limit').checked;
        
        saveData(); 
        showToast('Tetapan disimpan.');
    }

    // --- Bulk Registration (UPDATED LOGIC) ---
    let currentLaneAssignments = {};

    window.openBulkRegModal = function(eventId) {
        if(!eventId) return;
        currentBulkEventId = eventId.toString();
        const ev = appData.events.find(e => e.id.toString() === currentBulkEventId);
        if(!ev) return;

        bulkSelectedAthletes = new Set((ev.participants || []).map(String));
        currentLaneAssignments = ev.laneAssignment || {};

        document.getElementById('modal-event-title').innerText = `${ev.code ? ev.code + ' - ' : ''}${ev.name} â€¢ ${ev.category}`;
        
        // Show Event Limit Status
        const limitBadge = document.getElementById('limit-status-badge');
        if(appData.config.enableEventLimit) {
            limitBadge.classList.remove('hidden', 'border-gray-600', 'text-gray-400');
            limitBadge.classList.add('border-green-500', 'text-green-400');
            limitBadge.innerText = `Had Aktif: ${appData.config.maxInd} (I) / ${appData.config.maxTeam} (P)`;
        } else {
            limitBadge.classList.add('hidden'); 
        }

        // Setup Filters
        const allClasses = [...new Set(appData.athletes.map(s => s.class))].filter(Boolean).sort();
        document.getElementById('modal-filter-class').innerHTML = '<option value="">Semua Kelas</option>' + allClasses.map(c => `<option value="${c}">${c}</option>`).join('');
        
        const allHouses = [...new Set(appData.athletes.map(s => s.house))].filter(Boolean).sort();
        document.getElementById('modal-filter-house').innerHTML = '<option value="">Semua Rumah</option>' + allHouses.map(h => `<option value="${getNormalizedHouseId(h)}">${getDisplayHouseName(h)}</option>`).join('');
        
        // RESET VIEW TO DEFAULT
        document.getElementById('reg-relay-choice-view').classList.add('hidden');
        document.getElementById('reg-selection-view').classList.add('hidden');
        document.getElementById('reg-lane-view').classList.add('hidden');
        document.getElementById('btn-reg-back').classList.add('hidden');
        document.getElementById('btn-reg-save').innerText = 'ğŸ’¾ Simpan';
        document.getElementById('btn-reg-save').setAttribute('onclick', 'handleRegAction()');

        // RELAY DETECTION
        // Detect "4x" pattern (e.g., 4x100m, 4x200)
        const isRelay = /4x\d+/i.test(ev.name); 

        if (isRelay) {
            // SHOW RELAY CHOICE POPUP (VIEW 0)
            document.getElementById('reg-relay-choice-view').classList.remove('hidden');
        } else {
            // NORMAL INDIVIDUAL EVENT
            // Strict Category Match Enabled
            isStrictCategoryFilter = true;
            document.getElementById('reg-selection-view').classList.remove('hidden');
            switchRegMode('individual'); 
            renderBulkStudentList(); 
        }

        // Populate Auto-Status Text
        const autoText = document.getElementById('auto-filter-status');
        let filters = [];
        if (ev.category) filters.push(`Kategori ${ev.category}`);
        autoText.innerText = filters.length > 0 ? `Menapis: ${filters.join(', ')}` : '';

        toggleModal('reg-modal');
    }

    // NEW: Handle Relay Mode Selection (Popup Buttons)
    window.handleRelayChoice = function(type) {
        document.getElementById('reg-relay-choice-view').classList.add('hidden');
        document.getElementById('reg-selection-view').classList.remove('hidden');

        if (type === 'individual') {
            // "Daftar Individu" -> Show ALL students (No Category Filter)
            isStrictCategoryFilter = false; 
            switchRegMode('individual');
            renderBulkStudentList();
        } else {
            // "Daftar Pasukan" -> Show Teams
            switchRegMode('team');
            renderTeamList();
        }
    }

    window.switchRegMode = function(mode) {
        currentRegMode = mode;
        const listInd = document.getElementById('modal-student-list');
        const listTeam = document.getElementById('modal-team-list');
        const filters = document.getElementById('reg-filters-container');

        if (mode === 'individual') {
            listInd.classList.remove('hidden');
            listTeam.classList.add('hidden');
            filters.classList.remove('hidden');
        } else {
            listTeam.classList.remove('hidden');
            listInd.classList.add('hidden');
            filters.classList.add('hidden');
        }
    }

    window.closeRegModal = function() { toggleModal('reg-modal'); document.getElementById('reg-event-select-bulk').value = ""; }

    window.renderBulkStudentList = function() {
        if(!currentBulkEventId) return;
        const container = document.getElementById('modal-student-list');
        const emptyMsg = document.getElementById('modal-empty-msg');
        
        const ev = appData.events.find(e => e.id.toString() === currentBulkEventId);
        
        const classFilter = document.getElementById('modal-filter-class').value;
        const houseFilter = document.getElementById('modal-filter-house').value;
        const search = document.getElementById('modal-search').value.toLowerCase();

        let eligibleStudents = appData.athletes;

        // FIXED LOGIC: Match category
        if (ev) {
            // STRICT FILTER (Only active for Normal Individual Events)
            if (isStrictCategoryFilter && ev.category) {
                eligibleStudents = eligibleStudents.filter(s => String(s.category).trim().toUpperCase() === String(ev.category).trim().toUpperCase());
            }
            
            // Gender match (Always active to avoid showing boys in girls' events)
            if (ev.gender) {
                 eligibleStudents = eligibleStudents.filter(s => String(s.gender).trim().toUpperCase() === String(ev.gender).trim().toUpperCase());
            }
        }

        if (classFilter) eligibleStudents = eligibleStudents.filter(s => s.class === classFilter);
        if (houseFilter) eligibleStudents = eligibleStudents.filter(s => getNormalizedHouseId(s.house) === houseFilter);
        if (search) eligibleStudents = eligibleStudents.filter(s => s.name.toLowerCase().includes(search));

        if(eligibleStudents.length === 0) { container.innerHTML = ''; emptyMsg.classList.remove('hidden'); return; }
        emptyMsg.classList.add('hidden');
        
        container.innerHTML = eligibleStudents.map(s => `
            <label class="flex items-center gap-3 p-3 bg-slate-800 rounded-lg border border-slate-600 hover:border-blue-500 cursor-pointer transition select-none">
                <input type="checkbox" onchange="toggleBulkSelection('${s.id}', this.checked)" ${bulkSelectedAthletes.has(s.id.toString()) ? 'checked' : ''} class="w-5 h-5 rounded text-blue-600 bg-slate-700 border-slate-500 focus:ring-0">
                <div class="flex-1 min-w-0"><div class="text-sm font-medium text-white truncate">${s.name}</div><div class="text-xs text-slate-400">${s.class} â€¢ ${getDisplayHouseName(s.house)} â€¢ <span class="text-yellow-500 font-bold">Kat ${s.category}</span></div></div>
            </label>
        `).join('');
        document.getElementById('modal-selected-count').innerText = `${bulkSelectedAthletes.size} peserta dipilih`;
    }

    window.renderTeamList = function() {
        if(!currentBulkEventId) return;
        const container = document.getElementById('modal-team-list');
        const houses = appData.houses.filter(h => h.active !== false);
        container.innerHTML = houses.map(h => `
            <label class="flex items-center gap-3 p-3 bg-slate-800 rounded-lg border border-slate-600 hover:border-blue-500 cursor-pointer transition select-none">
                <input type="checkbox" name="team_select" value="${h.id}" class="w-5 h-5 rounded text-blue-600 bg-slate-700 border-slate-500 focus:ring-0">
                <div class="flex-1 min-w-0"><div class="text-sm font-medium text-white">Pasukan ${h.name}</div><div class="text-xs text-slate-400" style="color:${getHouseColor(h.id)}">Wakil Rumah Sukan</div></div>
            </label>
        `).join('');
    }

    // ... (toggleBulkSelection, handleRegAction, etc. kept largely the same) ...
    window.toggleBulkSelection = function(athleteId, isChecked) {
        if (isChecked) {
            if (appData.config.enableEventLimit) {
                const athlete = appData.athletes.find(a => a.id.toString() === athleteId.toString());
                if (athlete) {
                    let indCount = 0;
                    let teamCount = 0;
                    
                    appData.events.forEach(e => {
                        // Check if athlete is ALREADY in this event (ignore current temp selection)
                        if (e.participants && e.participants.map(String).includes(athleteId.toString())) {
                            // Determine type based on name keywords
                            const isTeam = e.name.toLowerCase().includes('4x') || e.name.toLowerCase().includes('kuartet');
                            if (isTeam) teamCount++;
                            else indCount++;
                        }
                    });

                    const currentEv = appData.events.find(e => e.id.toString() === currentBulkEventId);
                    const isCurrentTeam = currentEv.name.toLowerCase().includes('4x') || currentEv.name.toLowerCase().includes('kuartet');
                    
                    const limitInd = appData.config.maxInd || 3;
                    const limitTeam = appData.config.maxTeam || 2;

                    if (isCurrentTeam) {
                        if (teamCount >= limitTeam) {
                            alert(`Had Maksimum Dicapai: ${athlete.name} telah menyertai ${teamCount}/${limitTeam} acara berkumpulan.`);
                            setTimeout(renderBulkStudentList, 50); 
                            return;
                        }
                    } else {
                        if (indCount >= limitInd) {
                            alert(`Had Maksimum Dicapai: ${athlete.name} telah menyertai ${indCount}/${limitInd} acara individu.`);
                            setTimeout(renderBulkStudentList, 50);
                            return;
                        }
                    }
                }
            }
            bulkSelectedAthletes.add(athleteId.toString());
        } else {
            bulkSelectedAthletes.delete(athleteId.toString());
        }
        document.getElementById('modal-selected-count').innerText = `${bulkSelectedAthletes.size} peserta dipilih`;
    }

    window.handleRegAction = function() {
        const ev = appData.events.find(e => e.id.toString() === currentBulkEventId);
        if(!ev) return;

        const isTrack = (ev.type === 'track') || (!ev.type && !ev.name.toLowerCase().includes('lompat') && !ev.name.toLowerCase().includes('lontar') && !ev.name.toLowerCase().includes('rejam'));

        if (isTrack && bulkSelectedAthletes.size > 0 && document.getElementById('reg-lane-view').classList.contains('hidden')) {
            showLaneAssignmentUI();
        } else {
            saveFinalRegistration();
        }
    }

    window.showLaneAssignmentUI = function() {
        document.getElementById('reg-selection-view').classList.add('hidden');
        document.getElementById('reg-lane-view').classList.remove('hidden');
        document.getElementById('btn-reg-back').classList.remove('hidden');
        document.getElementById('btn-reg-save').innerText = 'ğŸ’¾ Simpan & Selesai';
        
        const container = document.getElementById('lane-assign-list');
        const selectedIds = Array.from(bulkSelectedAthletes);
        
        const athletes = selectedIds.map(id => appData.athletes.find(a => a.id.toString() === id.toString())).filter(a => a);
        
        container.innerHTML = athletes.map(a => {
            const assignedLane = currentLaneAssignments[a.id] || '';
            return `
            <div class="flex items-center justify-between bg-slate-800 p-3 rounded-lg border border-slate-600">
                <div>
                    <div class="font-bold text-white">${a.name}</div>
                    <div class="text-xs text-slate-400">${a.class} â€¢ ${getDisplayHouseName(a.house)}</div>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-xs text-slate-400">Lorong:</span>
                    <select onchange="updateLane('${a.id}', this.value)" class="bg-slate-700 text-white text-sm rounded px-2 py-1 border border-slate-500 focus:border-blue-500 outline-none w-16 text-center">
                        <option value="">-</option>
                        ${[1,2,3,4,5,6,7,8].map(n => `<option value="${n}" ${assignedLane == n ? 'selected' : ''}>${n}</option>`).join('')}
                    </select>
                </div>
            </div>
            `;
        }).join('');
    }

    window.updateLane = function(athleteId, lane) {
        if(lane) currentLaneAssignments[athleteId] = lane;
        else delete currentLaneAssignments[athleteId];
    }

    window.backToSelection = function() {
        document.getElementById('reg-selection-view').classList.remove('hidden');
        document.getElementById('reg-lane-view').classList.add('hidden');
        document.getElementById('btn-reg-back').classList.add('hidden');
        document.getElementById('btn-reg-save').innerText = 'ğŸ’¾ Simpan';
    }

    window.saveFinalRegistration = function() {
        const ev = appData.events.find(e => e.id.toString() === currentBulkEventId);
        if(!ev) return;

        if (currentRegMode === 'individual') {
             ev.participants = Array.from(bulkSelectedAthletes);
        } else {
             const teamCheckboxes = document.querySelectorAll('input[name="team_select"]:checked');
             teamCheckboxes.forEach(cb => {
                 const houseId = cb.value; 
                 const houseName = getDisplayHouseName(houseId);
                 const teamName = `Kuartet ${houseName}`;
                 // Check if this quartet already exists as a pseudo-athlete
                 let teamAthlete = appData.athletes.find(a => a.name === teamName && a.category === ev.category && a.gender === ev.gender);
                 if (!teamAthlete) {
                     // Create new pseudo-athlete for the team
                     teamAthlete = { 
                         id: Date.now() + Math.random(), 
                         name: teamName, 
                         class: 'Pasukan', 
                         gender: ev.gender, 
                         house: houseId, 
                         category: ev.category, 
                         medals: {gold:0, silver:0, bronze:0}, 
                         points: 0 
                     };
                     appData.athletes.push(teamAthlete);
                 }
                 if (!ev.participants) ev.participants = [];
                 // Ensure no duplicates
                 if (!ev.participants.map(String).includes(teamAthlete.id.toString())) {
                     ev.participants.push(teamAthlete.id.toString());
                 }
             });
        }

        ev.laneAssignment = currentLaneAssignments;

        saveData();
        showToast(`Yahoo ! Pendaftaran untuk ${ev.name} berjaya!`);
        closeRegModal();
    }
    
    // ... (Rest of the functions: manual entry, uploads, printing, delete, etc. remain unchanged) ...
    // Note: Due to character limits, I'm ensuring the key changed logic is above. 
    // The rest of the file follows the previous structure exactly.

    window.addStudentManual = function() {
        const name = document.getElementById('manual-name').value.trim();
        const className = document.getElementById('manual-class').value.trim();
        const house = document.getElementById('manual-house').value;
        const gender = document.getElementById('manual-gender').value;
        const category = document.getElementById('manual-category').value.trim();

        if(!name || !className || !house || !gender || !category) {
            return showToast("Sila isi semua maklumat.", "error");
        }

        const newStudent = {
            id: Date.now() + Math.random(),
            name: name,
            class: className,
            house: house,
            gender: gender,
            category: category,
            medals: {gold:0, silver:0, bronze:0},
            points: 0
        };

        appData.athletes.push(newStudent);
        saveData();
        showToast("Murid berjaya ditambah.");
        document.getElementById('manual-name').value = '';
        document.getElementById('manual-class').value = '';
        document.getElementById('manual-house').value = '';
        document.getElementById('manual-gender').value = '';
        document.getElementById('manual-category').value = '';
        renderUploadedStudentPreview();
        refreshDropdowns();
    }

    // ... (Standard upload functions same as previous) ...
    window.uploadExcelStudents = async function() {
        const fileInput = document.getElementById('excel-upload');
        const file = fileInput.files[0];
        if (!file) return showToast('Sila pilih fail!', 'error');
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                let count = 0; let updatedCount = 0;
                for(let i=0; i<jsonData.length; i++) {
                    const row = jsonData[i];
                    if(!row) continue;
                    const name = String(row['NAMA'] || '').trim();
                    const className = String(row['KELAS'] || '').trim();
                    if(!name) continue;
                    const existingIndex = appData.athletes.findIndex(a => a.name.toLowerCase() === name.toLowerCase() && a.class.toLowerCase() === className.toLowerCase());
                    const houseRaw = row['RUMAH SUKAN'];
                    const houseFormatted = houseRaw ? String(houseRaw).trim() : "Tidak Diketahui";
                    const athleteData = { name: name, class: className, gender: mapGender(row['JANTINA']), house: houseFormatted, category: row['KATEGORI'] ? String(row['KATEGORI']).toUpperCase().trim() : 'A' };
                    if (existingIndex > -1) { appData.athletes[existingIndex] = { ...appData.athletes[existingIndex], ...athleteData }; updatedCount++; } 
                    else { if(appData.athletes.length >= 2000) break; appData.athletes.push({ id: Date.now() + Math.random(), ...athleteData, medals: {gold:0, silver:0, bronze:0}, points: 0 }); count++; }
                }
                saveData(); showToast(`${count} murid baru, ${updatedCount} dikemaskini.`); fileInput.value = ''; renderUploadedStudentPreview(); refreshDropdowns(); 
            } catch(err) { showToast('Gagal memproses fail.', 'error'); console.error(err); }
        };
        reader.readAsArrayBuffer(file);
    }

    window.renderUploadedStudentPreview = function() {
        const container = document.getElementById('upload-preview-container');
        const tbody = document.getElementById('upload-preview-body');
        const classFilter = document.getElementById('preview-filter-class').value;
        if(appData.athletes.length === 0) { container.classList.add('hidden'); return; }
        container.classList.remove('hidden');
        const classes = [...new Set(appData.athletes.map(s => s.class))].filter(Boolean).sort();
        const select = document.getElementById('preview-filter-class');
        if (select.options.length <= 1) select.innerHTML = '<option value="">Semua Kelas</option>' + classes.map(c => `<option value="${c}">${c}</option>`).join('');
        const filtered = appData.athletes.filter(s => classFilter === '' || s.class === classFilter);
        tbody.innerHTML = filtered.map(s => `<tr class="hover:bg-slate-700/50"><td class="p-2 font-medium">${s.name}</td><td class="p-2 text-slate-400">${s.class}</td><td class="p-2"><span class="inline-block w-2 h-2 rounded-full mr-1" style="background: ${getHouseColor(getNormalizedHouseId(s.house))}"></span>${getDisplayHouseName(s.house)}</td><td class="p-2 text-center"><button onclick="deleteStudent('${s.id}')" class="text-red-400 hover:text-red-300 p-1 hover:bg-slate-600 rounded" title="Padam Murid"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></td></tr>`).join('');
    }

    window.deleteStudent = function(id) { if(confirm("Adakah anda pasti mahu memadam murid ini?")) { const initialLength = appData.athletes.length; appData.athletes = appData.athletes.filter(a => a.id.toString() !== id.toString()); if (appData.athletes.length < initialLength) { saveData(); showToast("Murid berjaya dipadam."); renderUploadedStudentPreview(); refreshDropdowns(); } else { showToast("Ralat: Murid tidak dijumpai.", "error"); } } }

    window.uploadSchedule = async function() {
        const fileInput = document.getElementById('upload-schedule'); const file = fileInput.files[0]; if (!file) return showToast('Sila pilih fail!', 'error');
        const reader = new FileReader(); reader.onload = function(e) { try { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type: 'array'}); const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header:1}); appData.scheduleItems = []; let count = 0; for(let i=1; i<jsonData.length; i++) { const row = jsonData[i]; if(!row || row.length === 0) continue; const time = row[0] ? String(row[0]).trim() : ''; const event = row[1] ? String(row[1]).trim() : ''; if(event) { appData.scheduleItems.push({ id: Date.now() + Math.random(), time: time, event: event, category: row[2] ? String(row[2]).trim() : '', venue: row[3] ? String(row[3]).trim() : '' }); count++; } } saveData(); showToast(`${count} jadual berjaya dimuat naik!`); fileInput.value = ''; renderSchedule(); renderSchedulePreview(); } catch(err) { showToast('Gagal memproses fail.', 'error'); console.error(err); } }; reader.readAsArrayBuffer(file);
    }

    window.processEventUpload = function() {
        const fileInput = document.getElementById('upload-events'); const file = fileInput.files[0]; if (!file) return showToast('Sila pilih fail!', 'error');
        const reader = new FileReader(); reader.onload = function(e) { try { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type: 'array'}); const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header:1}); let count = 0; for(let i=1; i<jsonData.length; i++) { const row = jsonData[i]; if(!row || !row[0]) continue; const code = row[0] ? String(row[0]).trim() : ''; const eventName = row[1] ? String(row[1]).trim() : ''; const categoryRaw = row[2] ? String(row[2]).trim() : ''; let gender = 'L'; if (eventName.toUpperCase().includes('PEREMPUAN') || eventName.toUpperCase().includes('WANITA') || (categoryRaw && categoryRaw.toUpperCase().startsWith('P'))) { gender = 'P'; } let eventType = 'track'; if (eventName.toUpperCase().includes('LOMPAT') || eventName.toUpperCase().includes('LONTAR') || eventName.toUpperCase().includes('REJAM')) { eventType = 'field'; } appData.events.push({ id: Date.now() + Math.random(), code: code, name: eventName, category: categoryRaw, gender: gender, type: eventType, status: 'upcoming', result: null, participants: [] }); count++; } saveData(); showToast(`${count} acara ditambah.`); fileInput.value = ''; refreshDropdowns(); renderEventPreview(); } catch(err) { showToast('Gagal memproses fail.', 'error'); console.error(err); } }; reader.readAsArrayBuffer(file);
    }

    window.addEventManual = function() {
        const code = document.getElementById('manual-event-code').value.trim(); const name = document.getElementById('manual-event-name').value.trim(); const type = document.getElementById('manual-event-type').value; const category = document.getElementById('manual-event-category').value.trim(); const gender = document.getElementById('manual-event-gender').value;
        if(!name || !category || !gender) { return showToast("Sila isi Nama, Kategori dan Jantina.", "error"); }
        appData.events.push({ id: Date.now() + Math.random(), code: code, name: name, category: category, gender: gender, type: type ? type.toLowerCase() : (name.toLowerCase().includes('lompat') || name.toLowerCase().includes('lontar') ? 'field' : 'track'), status: 'upcoming', result: null, participants: [] });
        saveData(); showToast("Acara berjaya ditambah."); document.getElementById('manual-event-code').value = ''; document.getElementById('manual-event-name').value = ''; document.getElementById('manual-event-type').value = ''; document.getElementById('manual-event-category').value = ''; document.getElementById('manual-event-gender').value = ''; refreshDropdowns(); renderEventPreview();
    }

    function mapGender(val) { if(!val) return 'L'; const v = String(val).toUpperCase(); return (v.startsWith('L') || v.includes('MALE')) ? 'L' : 'P'; }

    // --- Result Logic (No Changes) ---
    window.loadEventParticipants = function() {
        const evId = document.getElementById('result-event').value; const stageDiv = document.getElementById('result-stage-container'); const tableDiv = document.getElementById('result-entry-table-container'); if(!evId) { stageDiv.classList.add('hidden'); tableDiv.classList.add('hidden'); return; } document.querySelectorAll('input[name="result-stage"]').forEach(el => el.checked = false); stageDiv.classList.remove('hidden'); tableDiv.classList.add('hidden');
    }

    window.toggleResultTable = function() {
        const evId = document.getElementById('result-event').value; if(!evId) return; const stage = document.querySelector('input[name="result-stage"]:checked')?.value; if(!stage) return;
        const ev = appData.events.find(e => e.id.toString() === evId); const tbody = document.getElementById('result-entry-tbody'); const tableDiv = document.getElementById('result-entry-table-container');
        let participants = []; if(ev.participants && ev.participants.length > 0) { participants = ev.participants.map(pid => appData.athletes.find(a => a.id.toString() === pid.toString())).filter(x => x); }
        if(participants.length === 0) { showToast("Tiada peserta didaftar untuk acara ini.", "error"); tableDiv.classList.add('hidden'); return; }
        tbody.innerHTML = participants.map(p => `<tr class="hover:bg-slate-800"><td class="p-3 border-b border-slate-700"><div class="font-bold text-white">${p.name}</div><div class="text-xs text-slate-400">${p.class} â€¢ ${getDisplayHouseName(p.house)}</div></td><td class="p-3 border-b border-slate-700"><select class="w-full bg-slate-800 border border-slate-600 rounded p-1 text-sm result-rank-input text-white" data-id="${p.id}"><option value="">-</option><option value="1">1 (Johan)</option><option value="2">2 (N.Johan)</option><option value="3">3 (Ketiga)</option><option value="4">4 (Keempat)</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select></td><td class="p-3 border-b border-slate-700"><input type="text" class="w-full bg-slate-800 border border-slate-600 rounded p-1 text-sm result-val-input text-white" data-id="${p.id}" placeholder="Masa/Jarak"></td></tr>`).join(''); tableDiv.classList.remove('hidden');
    }

    window.submitDetailedResult = function() {
        const evId = document.getElementById('result-event').value; const stage = document.querySelector('input[name="result-stage"]:checked')?.value;
        if(!evId || !stage) return showToast("Sila pilih acara dan peringkat.", "error");
        const ev = appData.events.find(e => e.id.toString() === evId); const rankInputs = document.querySelectorAll('.result-rank-input'); const valInputs = document.querySelectorAll('.result-val-input');
        let winners = []; let hasWinner = false;
        rankInputs.forEach((input, index) => { const athleteId = input.dataset.id; const rank = input.value; const value = valInputs[index].value; const athlete = appData.athletes.find(a => a.id.toString() === athleteId);
            if(rank && athlete) { hasWinner = true; winners.push({ name: athlete.name, house: getDisplayHouseName(athlete.house), rank: rank, value: value });
                if(stage === "Akhir") { if(rank === "1") { athlete.medals.gold++; athlete.points += appData.pointsConfig.gold; } else if(rank === "2") { athlete.medals.silver++; athlete.points += appData.pointsConfig.silver; } else if(rank === "3") { athlete.medals.bronze++; athlete.points += appData.pointsConfig.bronze; } else if(rank === "4") { athlete.points += appData.pointsConfig.fourth; } } } });
        if(!hasWinner) return showToast("Sila pilih sekurang-kurangnya seorang pemenang.", "error");
        if(!appData.resultsLog) appData.resultsLog = []; appData.resultsLog = appData.resultsLog.filter(l => !(l.eventId === ev.id && l.stage === stage));
        appData.resultsLog.push({ eventId: ev.id, eventName: ev.name, stage: stage, winners: winners, timestamp: new Date().toISOString() });
        if(stage === "Akhir") ev.status = 'completed'; if(stage === "Akhir") ev.result = { winners };
        saveData(); showToast("Keputusan berjaya disimpan!"); document.getElementById('result-event').value = ""; document.getElementById('result-stage-container').classList.add('hidden'); document.getElementById('result-entry-table-container').classList.add('hidden'); renderCompletedResultsTable(); renderScreeningResultsTable();
    }

    // ... (Completed, Screening Results, Print functions same as previous) ...
    window.renderCompletedResultsTable = function() {
        const container = document.getElementById('completed-results-tbody'); const completed = appData.events.filter(e => e.status === 'completed');
        if(completed.length === 0) { container.innerHTML = '<tr><td colspan="2" class="p-3 text-center text-slate-500 italic">Tiada acara selesai.</td></tr>'; return; }
        container.innerHTML = completed.map(e => `<tr class="hover:bg-slate-800 border-b border-slate-700"><td class="p-3 text-white"><div class="font-bold">${e.name}</div><div class="text-xs text-slate-400">${e.category}</div></td><td class="p-3 text-center"><button onclick="printSingleResult('${e.id}')" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded text-xs font-bold flex items-center gap-1 mx-auto"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg> Cetak PDF</button></td></tr>`).join('');
    }

    window.renderScreeningResultsTable = function() {
        const container = document.getElementById('screening-results-tbody'); if (!appData.resultsLog) { container.innerHTML = '<tr><td colspan="3" class="p-3 text-center text-slate-500 italic">Tiada data log.</td></tr>'; return; }
        const screenings = appData.resultsLog.filter(l => l.stage === 'Saringan').reverse();
        if(screenings.length === 0) { container.innerHTML = '<tr><td colspan="3" class="p-3 text-center text-slate-500 italic">Tiada keputusan saringan.</td></tr>'; return; }
        container.innerHTML = screenings.map(log => { const ev = appData.events.find(e => e.id.toString() === log.eventId.toString()); const eventName = ev ? `${ev.name} (${ev.category})` : log.eventName; const dateStr = new Date(log.timestamp).toLocaleDateString('ms-MY') + ' ' + new Date(log.timestamp).toLocaleTimeString('ms-MY', {hour: '2-digit', minute:'2-digit'}); return `<tr class="hover:bg-slate-800 border-b border-slate-700"><td class="p-3 text-white"><div class="font-bold">${eventName}</div></td><td class="p-3 text-slate-400 text-xs">${dateStr}</td><td class="p-3 text-center"><button onclick="printScreeningResult('${log.eventId}')" class="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1 rounded text-xs font-bold flex items-center gap-1 mx-auto"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg> PDF</button></td></tr>`}).join('');
    }

    // Print logic maintained (Screening & Single Result & Forms)
    window.printScreeningResult = function(eventId) { const log = appData.resultsLog.slice().reverse().find(l => l.eventId.toString() === eventId.toString() && l.stage === 'Saringan'); const ev = appData.events.find(e => e.id.toString() === eventId.toString()); if (!log) return showToast("Tiada data keputusan saringan ditemui.", "error"); currentPdfFilename = `Saringan_${ev ? ev.name.replace(/\s+/g, '_') : 'Acara'}.pdf`; const contentDiv = document.getElementById('pdf-preview-content'); contentDiv.innerHTML = ''; const page = document.createElement('div'); page.className = 'pdf-page'; const winners = log.winners.sort((a,b) => a.rank - b.rank); const rows = winners.map(w => `<tr class="border-b border-gray-300"><td class="p-2 text-center border-r border-gray-300 font-bold">${w.rank}</td><td class="p-2 border-r border-gray-300 font-semibold uppercase">${w.name}</td><td class="p-2 text-center border-r border-gray-300">${w.house}</td><td class="p-2 text-center">${w.value || '-'}</td></tr>`).join(''); page.innerHTML = `<div class="text-center border-b-2 border-black pb-2 mb-6"><h1 class="text-xl font-bold uppercase">${appData.config.schoolName}</h1><h2 class="text-sm font-semibold uppercase">KEPUTUSAN SARINGAN - ${appData.config.year}</h2></div><div class="mb-4 p-2 bg-gray-100 border border-gray-300"><div class="flex justify-between font-bold text-sm uppercase"><span>ACARA: ${ev ? ev.name : log.eventName}</span><span>KATEGORI: ${ev ? ev.category : '-'}</span></div></div><table class="w-full border border-black text-sm mb-8"><thead class="bg-gray-200 border-b border-black font-bold"><tr><th class="p-2 border-r border-black w-16">KED</th><th class="p-2 border-r border-black text-left">NAMA PEMENANG</th><th class="p-2 border-r border-black w-32">RUMAH</th><th class="p-2 w-32">CATATAN</th></tr></thead><tbody>${rows}</tbody></table><div class="mt-12 flex justify-end"><div class="text-center w-64"><div class="border-t border-black pt-2 text-xs font-bold">TANDATANGAN REFERI BALAPAN</div></div></div>`; contentDiv.appendChild(page); document.getElementById('pdf-preview-modal').classList.remove('hidden'); }

    window.printSingleResult = function(eventId) { const ev = appData.events.find(e => e.id.toString() === eventId.toString()); const log = appData.resultsLog.slice().reverse().find(l => l.eventId === ev.id && l.stage === 'Akhir'); if (!log) return showToast("Tiada data keputusan ditemui.", "error"); currentPdfFilename = `Keputusan_${ev.name.replace(/\s+/g, '_')}.pdf`; const contentDiv = document.getElementById('pdf-preview-content'); contentDiv.innerHTML = ''; const page = document.createElement('div'); page.className = 'pdf-page'; const winners = log.winners.sort((a,b) => a.rank - b.rank); const rows = winners.map(w => `<tr class="border-b border-gray-300"><td class="p-2 text-center border-r border-gray-300 font-bold">${w.rank}</td><td class="p-2 border-r border-gray-300 font-semibold uppercase">${w.name}</td><td class="p-2 text-center border-r border-gray-300">${w.house}</td><td class="p-2 text-center">${w.value || '-'}</td></tr>`).join(''); page.innerHTML = `<div class="text-center border-b-2 border-black pb-2 mb-6"><h1 class="text-xl font-bold uppercase">${appData.config.schoolName}</h1><h2 class="text-sm font-semibold uppercase">KEPUTUSAN RASMI - ${appData.config.year}</h2></div><div class="mb-4 p-2 bg-gray-100 border border-gray-300"><div class="flex justify-between font-bold text-sm uppercase"><span>ACARA: ${ev.name}</span><span>KATEGORI: ${ev.category}</span></div></div><table class="w-full border border-black text-sm mb-8"><thead class="bg-gray-200 border-b border-black font-bold"><tr><th class="p-2 border-r border-black w-16">KED</th><th class="p-2 border-r border-black text-left">NAMA PEMENANG</th><th class="p-2 border-r border-black w-32">RUMAH</th><th class="p-2 w-32">CATATAN</th></tr></thead><tbody>${rows}</tbody></table><div class="mt-12 flex justify-end"><div class="text-center w-64"><div class="border-t border-black pt-2 text-xs font-bold">TANDATANGAN REFERI BALAPAN</div></div></div>`; contentDiv.appendChild(page); document.getElementById('pdf-preview-modal').classList.remove('hidden'); }

    const isFieldEvent = (eventOrName) => { if (typeof eventOrName === 'object' && eventOrName !== null) { if (eventOrName.type === 'field') return true; if (eventOrName.type === 'track') return false; return isFieldEvent(eventOrName.name); } if (!eventOrName) return false; const n = eventOrName.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g," ").replace(/\s{2,}/g," ").trim(); const fieldKeywords = ['lompat', 'high jump', 'long jump', 'triple jump', 'pole vault', 'kijang', 'galah', 'lontar', 'shot', 'put', 'peluru', 'rejam', 'javelin', 'lembing', 'lempar', 'discus', 'cakera', 'tukul', 'hammer', 'baling', 'l jauh', 'l tinggi', 'l kijang', 'l galah', 'ljauh', 'ltinggi', 'lkijang', 'lgalah', 'r lembing', 'm lembing']; return fieldKeywords.some(keyword => n.includes(keyword)); };

    window.printFieldForms = function() { const container = document.getElementById('pdf-preview-content'); container.innerHTML = ''; currentPdfFilename = `Borang_Hakim_Padang_${appData.config.year}.pdf`; currentPdfOrientation = 'landscape'; if (!appData.events || appData.events.length === 0) return showToast("Tiada acara untuk dicetak.", "error"); const fieldEvents = appData.events.filter(e => isFieldEvent(e)); if (fieldEvents.length === 0) { return showToast("Tiada acara Padang ditemui.", "error"); } fieldEvents.sort((a,b) => a.name.localeCompare(b.name)); fieldEvents.forEach((ev, index) => { let participants = []; if (ev.participants && ev.participants.length > 0) { participants = ev.participants.map(pid => appData.athletes.find(a => a.id.toString() === pid.toString())).filter(x => x); } participants.sort((a,b) => (a.class || '').localeCompare(b.class || '') || a.name.localeCompare(b.name)); const page = document.createElement('div'); page.className = 'pdf-page landscape'; let html = `<div class="text-center border-b-2 border-black pb-2 mb-4"><h1 class="text-xl font-bold uppercase">${appData.config.schoolName}</h1><h2 class="text-sm font-semibold uppercase">BORANG HAKIM - ${appData.config.year}</h2></div><div class="flex justify-between items-center mb-4 border p-2 bg-gray-100 text-xs shadow-sm"><div class="w-1/4"><strong>NO. ACARA:</strong> ${ev.code || '-'}</div><div class="w-1/4"><strong>ACARA:</strong> <span class="uppercase font-bold text-sm">${ev.name}</span></div><div class="w-1/4 text-center"><strong>KATEGORI:</strong> <span class="bg-black text-white px-2 py-0.5 rounded">${ev.category}</span></div><div class="w-1/4 text-right font-bold text-gray-600 uppercase">ACARA PADANG (FIELD)</div></div>`; const rows = participants.length === 0 ? `<tr><td colspan="14" class="text-center py-12 italic text-gray-400">Tiada pendaftaran peserta.</td></tr>` : participants.map((p, i) => `<tr class="border-b border-gray-300 h-8 text-[10px]"><td class="p-1 text-center border-r border-gray-300">${i + 1}</td><td class="p-1 border-r border-gray-300 pl-2 font-semibold uppercase truncate max-w-[150px] text-left">${p.name}</td><td class="p-1 text-center border-r border-gray-300">${p.class || '-'}</td><td class="p-1 text-center border-r border-gray-300">${getDisplayHouseName(p.house)}</td><td class="border-r border-gray-300 w-4"></td><td class="border-r border-gray-300 w-4"></td><td class="border-r border-black w-4 bg-gray-100"></td><td class="border-r border-gray-300 w-4"></td><td class="border-r border-gray-300 w-4"></td><td class="border-r border-black w-4 bg-gray-100"></td><td class="border-r border-gray-300 w-4"></td><td class="border-r border-gray-300 w-4"></td><td class="border-r border-black w-4 bg-gray-100"></td><td class="border-r border-gray-300 w-4"></td><td class="border-r border-gray-300 w-4"></td><td class="border-r border-black w-4 bg-gray-100"></td><td class="border-r border-gray-300 w-4"></td><td class="border-r border-gray-300 w-4"></td><td class="border-r border-black w-4 bg-gray-100"></td><td class="border-r border-gray-300 w-4"></td><td class="border-r border-gray-300 w-4"></td><td class="border-r border-black w-4 bg-gray-100"></td><td class="border-r border-gray-300 w-4"></td><td class="border-r border-gray-300 w-4"></td><td class="border-r border-black w-4 bg-gray-100"></td><td class="border-r border-gray-300 w-4"></td><td class="border-r border-gray-300 w-4"></td><td class="border-r border-black w-4 bg-gray-100"></td><td class="border-r border-gray-300 w-8"></td> <td></td></tr>`).join(''); html += `<table class="w-full border border-black text-[10px]"><thead class="bg-gray-200 border-b border-black font-bold text-center"><tr><th rowspan="2" class="p-1 border-r border-black w-6">BIL</th><th rowspan="2" class="p-1 border-r border-black w-48 text-left pl-2">NAMA PESERTA</th><th rowspan="2" class="p-1 border-r border-black w-10">KELAS</th><th rowspan="2" class="p-1 border-r border-black w-12">RUMAH</th><th colspan="24" class="p-1 border-r border-black border-b border-gray-400">PERCUBAAN (JARAK/TINGGI)</th><th rowspan="2" class="p-1 border-r border-black w-8">KED</th><th rowspan="2" class="p-1 w-16">CATATAN</th></tr><tr><th class="border-r border-gray-400 w-4"></th><th class="border-r border-gray-400 w-4"></th><th class="border-r border-black w-4 bg-gray-300"></th><th class="border-r border-gray-400 w-4"></th><th class="border-r border-gray-400 w-4"></th><th class="border-r border-black w-4 bg-gray-300"></th><th class="border-r border-gray-400 w-4"></th><th class="border-r border-gray-400 w-4"></th><th class="border-r border-black w-4 bg-gray-300"></th><th class="border-r border-gray-400 w-4"></th><th class="border-r border-gray-400 w-4"></th><th class="border-r border-black w-4 bg-gray-300"></th><th class="border-r border-gray-400 w-4"></th><th class="border-r border-gray-400 w-4"></th><th class="border-r border-black w-4 bg-gray-300"></th><th class="border-r border-gray-400 w-4"></th><th class="border-r border-gray-400 w-4"></th><th class="border-r border-black w-4 bg-gray-300"></th><th class="border-r border-gray-400 w-4"></th><th class="border-r border-gray-400 w-4"></th><th class="border-r border-black w-4 bg-gray-300"></th><th class="border-r border-gray-400 w-4"></th><th class="border-r border-gray-400 w-4"></th><th class="border-r border-black w-4 bg-gray-300"></th></tr></thead><tbody>${rows}</tbody></table><div class="mt-2 text-[9px] text-gray-500 italic">* Tanda 'X' untuk gagal, '-' untuk tiada percubaan.</div>`; html += `<div class="mt-12 flex justify-between text-[10px] pt-4"><div class="text-center w-1/4"><div class="border-b border-black mb-1 h-8"></div><div class="font-bold">TANDATANGAN HAKIM</div></div><div class="text-center w-1/4"><div class="border-b border-black mb-1 h-8"></div><div class="font-bold">TANDATANGAN PENCATAT</div></div><div class="text-center w-1/4"><div class="border-b border-black mb-1 h-8"></div><div class="font-bold">PENGESAHAN REFERI</div></div></div><div class="absolute bottom-5 left-10 right-10 flex justify-between text-[8px] text-gray-400 border-t pt-1"><span>Dicetak: ${new Date().toLocaleDateString('ms-MY')} ${new Date().toLocaleTimeString('ms-MY')}</span><span>Sistem Pengurusan Sukan Sekolah</span></div>`; page.innerHTML = html; container.appendChild(page); }); document.getElementById('pdf-preview-modal').classList.remove('hidden');
    }

    window.printTrackForms = function() { const container = document.getElementById('pdf-preview-content'); container.innerHTML = ''; currentPdfFilename = `Borang_Hakim_Balapan_${appData.config.year}.pdf`; currentPdfOrientation = 'portrait'; if (!appData.events || appData.events.length === 0) return showToast("Tiada acara untuk dicetak.", "error"); const trackEvents = appData.events.filter(e => !isFieldEvent(e)); if (trackEvents.length === 0) { return showToast("Tiada acara Balapan ditemui.", "error"); } trackEvents.sort((a,b) => a.name.localeCompare(b.name)); trackEvents.forEach((ev, index) => { let participants = []; if (ev.participants && ev.participants.length > 0) { participants = ev.participants.map(pid => appData.athletes.find(a => a.id.toString() === pid.toString())).filter(x => x); } const laneMap = ev.laneAssignment || {}; participants.sort((a,b) => (a.class || '').localeCompare(b.class || '') || a.name.localeCompare(b.name)); const page = document.createElement('div'); page.className = 'pdf-page'; let html = `<div class="text-center border-b-2 border-black pb-2 mb-4"><h1 class="text-xl font-bold uppercase">${appData.config.schoolName}</h1><h2 class="text-sm font-semibold uppercase">BORANG HAKIM - ${appData.config.year}</h2></div><div class="flex justify-between items-center mb-4 border p-2 bg-gray-100 text-xs shadow-sm"><div class="w-1/4"><strong>NO. ACARA:</strong> ${ev.code || '-'}</div><div class="w-1/4"><strong>ACARA:</strong> <span class="uppercase font-bold text-sm">${ev.name}</span></div><div class="w-1/4 text-center"><strong>KATEGORI:</strong> <span class="bg-black text-white px-2 py-0.5 rounded">${ev.category}</span></div><div class="w-1/4 text-right font-bold text-gray-600 uppercase">ACARA BALAPAN (TRACK)</div></div>`; const rows = participants.length === 0 ? `<tr><td colspan="7" class="text-center py-12 italic text-gray-400">Tiada pendaftaran peserta.</td></tr>` : participants.map((p, i) => { const lorong = laneMap[p.id] || '-'; return `<tr class="border-b border-gray-300 h-10 text-xs"><td class="p-2 text-center border-r border-gray-300">${i + 1}</td><td class="p-2 text-center border-r border-gray-300 font-bold bg-gray-50 text-base">${lorong}</td><td class="p-2 border-r border-gray-300 pl-3 font-semibold uppercase text-left">${p.name}</td><td class="p-2 text-center border-r border-gray-300">${p.class || '-'}</td><td class="p-2 text-center border-r border-gray-300">${getDisplayHouseName(p.house)}</td><td class="p-2 text-center border-r border-gray-300"></td><td class="p-2 text-center"></td></tr>`}).join(''); html += `<table class="w-full border border-black text-xs"><thead class="bg-gray-200 border-b border-black font-bold"><tr><th class="p-2 border-r border-black w-10">BIL</th><th class="p-2 border-r border-black w-16 bg-gray-300">LORONG</th><th class="p-2 border-r border-black text-left pl-3">NAMA PESERTA</th><th class="p-2 border-r border-black w-20">KELAS</th><th class="p-2 border-r border-black w-24">RUMAH</th><th class="p-2 border-r border-black w-16">KED</th><th class="p-2 w-32">MASA / CATATAN</th></tr></thead><tbody>${rows}</tbody></table><div class="mt-2 text-[9px] text-gray-500 italic">* Sila isikan masa dalam format MM:SS.ms atau SS.ms.</div>`; html += `<div class="mt-12 flex justify-between text-[10px] pt-4"><div class="text-center w-1/4"><div class="border-b border-black mb-1 h-8"></div><div class="font-bold">TANDATANGAN HAKIM</div></div><div class="text-center w-1/4"><div class="border-b border-black mb-1 h-8"></div><div class="font-bold">TANDATANGAN PENCATAT</div></div><div class="text-center w-1/4"><div class="border-b border-black mb-1 h-8"></div><div class="font-bold">PENGESAHAN REFERI</div></div></div><div class="absolute bottom-5 left-10 right-10 flex justify-between text-[8px] text-gray-400 border-t pt-1"><span>Dicetak: ${new Date().toLocaleDateString('ms-MY')} ${new Date().toLocaleTimeString('ms-MY')}</span><span>Sistem Pengurusan Sukan Sekolah</span></div>`; page.innerHTML = html; container.appendChild(page); }); document.getElementById('pdf-preview-modal').classList.remove('hidden');
    }

    // --- NEW FUNCTIONS FOR DELETE/OVERWRITE (RESTORED) ---
    window.deleteAllStudents = function() { if(confirm("AWAS: Anda akan memadam SEMUA data murid. Tindakan ini tidak boleh dikembalikan. Teruskan?")) { appData.athletes = []; saveData(); renderUploadedStudentPreview(); refreshDropdowns(); showToast("Semua data murid berjaya dipadam.", "success"); } }
    window.deleteAllEvents = function() { if(confirm("AWAS: Anda akan memadam SEMUA acara. Keputusan sedia ada mungkin terjejas. Teruskan?")) { appData.events = []; appData.resultsLog = []; saveData(); renderEventPreview(); refreshDropdowns(); showToast("Semua acara berjaya dipadam.", "success"); } }
    window.deleteEvent = function(id) { if(confirm("Padam acara ini?")) { appData.events = appData.events.filter(e => e.id.toString() !== id.toString()); saveData(); renderEventPreview(); refreshDropdowns(); showToast("Acara dipadam."); } }
    window.deleteAllSchedule = function() { if(confirm("AWAS: Anda akan memadam keseluruhan jadual. Teruskan?")) { appData.scheduleItems = []; saveData(); renderSchedulePreview(); renderSchedule(); showToast("Jadual berjaya dikosongkan.", "success"); } }
    window.deleteScheduleItem = function(id) { if(confirm("Padam item jadual ini?")) { appData.scheduleItems = appData.scheduleItems.filter(s => s.id.toString() !== id.toString()); saveData(); renderSchedulePreview(); renderSchedule(); showToast("Item jadual dipadam."); } }
    window.renderEventPreview = function() { const container = document.getElementById('event-preview-container'); const tbody = document.getElementById('event-preview-body'); if(!appData.events || appData.events.length === 0) { container.classList.add('hidden'); return; } container.classList.remove('hidden'); tbody.innerHTML = appData.events.map(e => `<tr class="hover:bg-slate-700/50"><td class="p-2 font-medium text-white">${e.code ? e.code : '-'}</td><td class="p-2 font-medium text-white">${e.name}</td><td class="p-2 text-slate-400">${e.category}</td><td class="p-2 text-center"><button onclick="deleteEvent('${e.id}')" class="text-red-400 hover:text-red-300 p-1 rounded" title="Padam"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></td></tr>`).join(''); }
    window.renderSchedulePreview = function() { const container = document.getElementById('schedule-preview-container'); const tbody = document.getElementById('schedule-preview-body'); if(!appData.scheduleItems || appData.scheduleItems.length === 0) { container.classList.add('hidden'); return; } container.classList.remove('hidden'); tbody.innerHTML = appData.scheduleItems.map(s => `<tr class="hover:bg-slate-700/50"><td class="p-2 font-medium text-white whitespace-nowrap">${s.time}</td><td class="p-2 text-slate-300 truncate max-w-[150px]">${s.event}</td><td class="p-2 text-center"><button onclick="deleteScheduleItem('${s.id}')" class="text-red-400 hover:text-red-300 p-1 rounded" title="Padam"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></td></tr>`).join(''); }
    window.requestReset = function() { toggleModal('reset-confirm-modal'); }
    window.performReset = async function() { toggleModal('reset-confirm-modal'); try { localStorage.clear(); appData = JSON.parse(JSON.stringify(defaultData)); if (isFirebaseReady && auth.currentUser) { const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'sukan_main_data', 'app_data'); await setDoc(docRef, defaultData); } showToast("Sistem berjaya di-reset. Refreshing...", "success"); setTimeout(() => location.reload(), 1000); } catch (error) { console.error("Reset failed", error); location.reload(); } }
    window.renderAll = function() { renderScoreboard(); renderAthletesList(); renderRanking(); renderChampions(); renderHopes(); renderSchedule(); if(!document.getElementById('login-modal').classList.contains('hidden')) initAdminInputs(); }
    document.addEventListener('DOMContentLoaded', () => { initFirebaseSync(); renderAll(); });
</script>
</body>
</html>